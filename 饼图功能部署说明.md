# 饼图功能部署说明

**功能版本**: v2.0.2
**更新日期**: 2025-11-09
**状态**: ✅ 开发完成，已通过API测试

---

## 功能概述

在签单保费周对比柱状图下方新增了3个占比分析饼图：

### 1. 险别组合占比图
- **数据字段**: `单套-险别`
- **统计维度**: 件数占比、保费占比
- **分类**: 单交、同保主全、同保交三、单保交三、单保主全（共5类）
- **API**: `POST /api/insurance-type-distribution`

### 2. 业务员保费区间占比图
- **统计维度**: 业务员按保费分档
- **分档标准**: 当日以 `<0、0-0.5万、0.5-1.5万、1.5-2万、2-3万、>=3万` 为基线；`近7天/近30天` 会将阈值按“当日阈值 × 天数”自适应放大，例如 `近7天` 的 `0-0.5万` 会显示为 `0-3.5万`
- **API**: `POST /api/premium-range-distribution`

### 3. 新转续占比图
- **数据字段**: `是否续保`（优先）或`车险新业务分类`（回退）
- **分类**: 新保、续保、转保
- **API**: `POST /api/renewal-type-distribution`

---

## 技术实现

### 后端改动
1. **data_processor.py** (新增3个方法):
   - `get_insurance_type_distribution()` - 险别组合分析
   - `get_premium_range_distribution()` - 保费区间分析
   - `get_renewal_type_distribution()` - 新转续分析

2. **api_server.py** (新增3个端点):
   - `POST /api/insurance-type-distribution`
   - `POST /api/premium-range-distribution`
   - `POST /api/renewal-type-distribution`

### 前端改动
1. **新增组件**: `frontend/src/components/dashboard/PieChartCard.vue`
   - 通用饼图卡片组件
   - 支持自定义配色、统计类型、加载状态
   - ECharts环形饼图，带百分比标签

2. **状态管理**: `frontend/src/stores/data.js`
   - 新增state: `insuranceTypeData`, `premiumRangeData`, `renewalTypeData`, `pieChartsLoading`
   - 新增actions: `fetchInsuranceTypeData`, `fetchPremiumRangeData`, `fetchRenewalTypeData`, `refreshPieCharts`

3. **Dashboard集成**: `frontend/src/views/Dashboard.vue`
   - 新增饼图区域section，响应式3列布局
   - 支持当日/近7天/近30天时间段切换
   - 筛选器联动刷新

---

## API 测试结果

### 测试1: 险别组合占比 (近7天)
```bash
curl -X POST http://localhost:5001/api/insurance-type-distribution \
  -H 'Content-Type: application/json' \
  -d '{"period": "last7d", "filters": {}}'
```

✅ **结果**:
- 同保主全: 2610件 (30.0%), 保费444万
- 同保交三: 2149件 (24.7%), 保费202万
- 单交: 3754件 (43.1%), 保费117万
- 单保交三: 151件 (1.7%), 保费15万
- 单保主全: 50件 (0.6%), 保费13万

### 测试2: 业务员保费区间占比 (近7天)
```bash
curl -X POST http://localhost:5001/api/premium-range-distribution \
  -H 'Content-Type: application/json' \
  -d '{"period": "last7d", "filters": {}}'
```

✅ **结果**:
- <0: 3人 (1.5%), 保费-1.2万
- 0-3.5万: 65人 (31.6%), 保费28万
- 3.5-10.5万: 36人 (17.5%), 保费50万
- 10.5-14万: 30人 (14.6%), 保费74万
- 14-21万: 27人 (13.1%), 保费105万
- >=21万: 48人 (23.3%), 保费673万

### 测试3: 新转续占比 (近7天)
```bash
curl -X POST http://localhost:5001/api/renewal-type-distribution \
  -H 'Content-Type: application/json' \
  -d '{"period": "last7d", "filters": {}}'
```

✅ **结果**:
- 转保: 4681件 (53.7%), 保费361万
- 续保: 3633件 (41.7%), 保费314万
- 新保: 400件 (4.6%), 保费114万

---

## 部署步骤

### 方式1: 使用项目启动脚本（推荐）

```bash
# 在项目根目录执行
./start_server.sh
```

启动脚本会自动：
1. 激活Python虚拟环境
2. 启动后端API服务器 (端口5001)
3. 启动前端开发服务器 (端口5173)

### 方式2: 手动启动

#### 后端
```bash
cd backend
source ../.venv/bin/activate  # Windows: .venv\Scripts\activate
python3 api_server.py
```

#### 前端
```bash
cd frontend
npm install  # 首次需要
npm run dev
```

---

## 验证步骤

1. **访问前端**: http://localhost:5173
2. **查看饼图区域**: 在周对比柱状图下方应显示3个饼图
3. **测试筛选联动**:
   - 切换三级机构/团队筛选器
   - 观察饼图数据是否同步更新
4. **测试时间段切换**:
   - 点击当日/近7天/近30天按钮
   - 观察饼图数据是否刷新

---

## 设计亮点

### 1. 防御性编程
- ✅ 字段缺失时返回友好错误信息
- ✅ 空数据显示占位符，不破坏页面
- ✅ API参数校验（period白名单、filters类型检查）
- ✅ 前端错误边界，饼图加载失败不影响其他功能

### 2. 弱耦合架构
- ✅ 每个饼图独立API端点
- ✅ 每个饼图独立state和action
- ✅ 饼图组件可复用，新增占比图无需重写
- ✅ 并行加载，失败隔离

### 3. 一致性设计
- ✅ 护眼配色与主图表统一
- ✅ 加载动画与KPI卡片一致
- ✅ 响应式布局与整体风格匹配
- ✅ 错误提示与全局Toast保持一致

### 4. 性能优化
- ✅ 3个饼图并行请求，减少总耗时
- ✅ Pinia缓存，避免重复请求
- ✅ 筛选器防抖，降低请求频率（已实现于FilterPanel）
- ✅ ECharts按需引入，减小bundle体积

---

## 后续优化建议

1. **数据导出**: 支持饼图数据导出为Excel/PNG
2. **更多维度**: 增加客户类别、险种大类占比图
3. **趋势对比**: 饼图支持周同比、月同比
4. **自定义分档**: 业务员保费区间支持自定义阈值
5. **数据钻取**: 点击饼图扇区，显示明细列表

---

## 文档更新记录

| 文件 | 更新内容 |
|------|---------|
| [CHANGELOG.md](./CHANGELOG.md) | 新增v2.0.2版本更新日志 |
| [.claude/skills/api-endpoint-design/SKILL.md](./.claude/skills/api-endpoint-design/SKILL.md) | 更新端点清单，新增3个API |
| [backend/data_processor.py](./backend/data_processor.py) | 新增3个分析方法（L993-L1362） |
| [backend/api_server.py](./backend/api_server.py) | 新增3个POST端点（L398-L661） |
| [frontend/src/components/dashboard/PieChartCard.vue](./frontend/src/components/dashboard/PieChartCard.vue) | 新增通用饼图组件 |
| [frontend/src/stores/data.js](./frontend/src/stores/data.js) | 新增饼图状态管理 |
| [frontend/src/views/Dashboard.vue](./frontend/src/views/Dashboard.vue) | 集成饼图区域 |

---

## 联系与支持

如遇到问题，请检查：
1. 后端服务是否正常启动 (http://localhost:5001/api/health)
2. 数据文件是否存在 (`车险清单_2025年10-11月_合并.csv`)
3. 浏览器控制台是否有错误信息
4. 检查`backend/backend.log`和`frontend/frontend.log`

---

**开发完成时间**: 2025-11-09
**开发者**: AI Assistant (Claude Code)
**版本**: v2.0.2
