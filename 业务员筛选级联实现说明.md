# 业务员筛选级联实现说明

## 需求
在全局筛选中，筛选业务员必须先选三级机构、再选团队，且只显示有该三级机构、该团队的业务员。

## 实现方案

### 1. 核心逻辑
在 `GlobalFilterPanel.vue` 中添加了业务员选项的级联过滤逻辑：

#### 1.1 业务员选项计算（computed）
```javascript
// 业务员选项（根据选中的三级机构和团队动态过滤）
const salespersonOptions = computed(() => {
  const selectedOrg = localFilters.value.org
  const selectedTeam = localFilters.value.team
  const staffMapping = filterStore.policyMapping?.staff_to_info || {}

  // 必须先选择三级机构
  if (!selectedOrg) {
    return []
  }

  // 过滤出符合条件的业务员
  const filteredStaff = Object.keys(staffMapping).filter(staffKey => {
    const info = staffMapping[staffKey]

    // 必须匹配选中的三级机构
    if (info['三级机构'] !== selectedOrg) {
      return false
    }

    // 如果选择了团队，必须匹配
    if (selectedTeam && info['团队简称'] !== selectedTeam) {
      return false
    }

    return true
  })

  return filteredStaff
})
```

#### 1.2 业务员选择器可用性
```javascript
// 业务员选择器是否可用
const isSalespersonAvailable = computed(() => {
  return !!localFilters.value.org
})
```

### 2. 用户体验优化

#### 2.1 禁用状态
- 当未选择三级机构时，业务员选择器处于禁用状态
- 标签显示提示文字"（需先选机构）"
- 下方显示帮助文本"请先选择三级机构，再选择业务员"

#### 2.2 自动清空逻辑
- **机构变更时**：自动清空业务员选择（因为可选业务员列表已完全改变）
- **团队变更时**：检查当前选中的业务员是否仍在新的过滤范围内，如果不在则自动清空

```javascript
// 三级机构变更处理
function handleOrgChange() {
  // ... 原有的团队清空逻辑 ...

  // 清空业务员选择（因为可选业务员列表已改变）
  localFilters.value.salesperson = 'all'
}

// 团队变更处理
function handleTeamChange() {
  const currentSalesperson = localFilters.value.salesperson

  if (currentSalesperson && currentSalesperson !== 'all') {
    // 检查当前业务员是否在新的过滤列表中
    if (!salespersonOptions.value.includes(currentSalesperson)) {
      // 如果不在，清空业务员选择
      localFilters.value.salesperson = 'all'
    }
  }
}
```

### 3. 模板更新

```vue
<!-- 业务员 -->
<div class="global-filter__field">
  <label class="global-filter__label" for="salesperson-select">
    业务员
    <span v-if="!isSalespersonAvailable" class="global-filter__field-hint">
      （需先选机构）
    </span>
  </label>
  <select
    id="salesperson-select"
    v-model="localFilters.salesperson"
    class="global-filter__select"
    :disabled="!isSalespersonAvailable"
    :aria-label="isSalespersonAvailable ? '选择业务员' : '业务员选项不可用，请先选择三级机构'"
    :aria-describedby="!isSalespersonAvailable ? 'salesperson-hint' : undefined"
  >
    <option value="all">全部</option>
    <option
      v-for="option in salespersonOptions"
      :key="option"
      :value="option"
    >
      {{ option }}
    </option>
  </select>
  <span v-if="!isSalespersonAvailable" id="salesperson-hint" class="global-filter__hint">
    请先选择三级机构，再选择业务员
  </span>
</div>
```

## 筛选流程

1. **初始状态**：业务员选择器禁用，提示"需先选机构"
2. **选择三级机构**：
   - 业务员选择器启用
   - 显示该机构下的所有业务员
   - 之前选择的业务员被清空
3. **选择团队**：
   - 业务员选项进一步过滤，只显示该团队的业务员
   - 如果之前选中的业务员不在该团队，自动清空
4. **修改机构或团队**：
   - 自动更新业务员选项列表
   - 必要时清空业务员选择

## 数据来源

业务员筛选依赖 `filterStore.policyMapping.staff_to_info`，该数据来自：
- 文件：`业务员机构团队归属.json`
- API：`/api/policy-mapping`
- 结构示例：
```json
{
  "200046585刘洋新": {
    "三级机构": "乐山",
    "四级机构": "乐山",
    "团队简称": null,
    "status": "在岗"
  }
}
```

## 注意事项

1. **团队为空的情况**：有些业务员的 `团队简称` 为 `null`，这类业务员：
   - 在未选择团队时会显示
   - 在选择了具体团队后会被过滤掉

2. **可访问性**：添加了完整的 ARIA 标签，确保屏幕阅读器用户能理解筛选器的状态

3. **性能优化**：使用 computed 属性自动缓存，只在依赖变化时重新计算

## 测试建议

1. 测试选择机构后业务员列表是否正确
2. 测试选择团队后业务员列表是否进一步过滤
3. 测试修改机构/团队时业务员选择是否正确清空
4. 测试未选择机构时业务员选择器是否正确禁用
