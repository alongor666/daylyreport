# 筛选器架构 - 可视化指南

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户浏览器 (Vue 3)                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    Dashboard.vue                          │   │
│  │  ┌────────────────────────────────────────────────────┐  │   │
│  │  │          工具栏 (Header)                           │  │   │
│  │  │  • 全局指标切换 (Premium ↔ Count)                 │  │   │
│  │  │  • 数据口径切换 (不含批改 ↔ 含批改)              │  │   │
│  │  │  • 时间周期选择 (当日/近7天/近30天)              │  │   │
│  │  └────────────────────────────────────────────────────┘  │   │
│  │                                                             │   │
│  │  ┌────────────────────────────────────────────────────┐  │   │
│  │  │          FilterPanel.vue (筛选面板)                │  │   │
│  │  │  ┌──────────────────────────────────────────────┐  │  │   │
│  │  │  │ 业务员    ┌─────────────┐                    │  │  │   │
│  │  │  │ 三级机构  │  活跃筛选    │                    │  │  │   │
│  │  │  │ 团队      │  标签显示    │                    │  │  │   │
│  │  │  │ 是否续保  │             │                    │  │  │   │
│  │  │  │ 是否新能源│[应用] [重置] │                   │  │  │   │
│  │  │  │ 是否过户车│             │                    │  │  │   │
│  │  │  │ 是否异地车│             │                    │  │  │   │
│  │  │  │ 险种大类  │             │                    │  │  │   │
│  │  │  │ 吨位      │             │                    │  │  │   │
│  │  │  └──────────────────────────────────────────────┘  │  │   │
│  │  └────────────────────────────────────────────────────┘  │   │
│  │                                                             │   │
│  │  ┌────────────────────────────────────────────────────┐  │   │
│  │  │    KPI卡片区域 (KpiCard × 8+)                      │  │   │
│  │  │    • 签单保费、签单单量、签单佣金、目标差距      │  │   │
│  │  │    • 电销/新能源/过户车/交强险占比等            │  │   │
│  │  └────────────────────────────────────────────────────┘  │   │
│  │                                                             │   │
│  │  ┌────────────────────────────────────────────────────┐  │   │
│  │  │    图表区域 (ChartView + PieChartCard)            │  │   │
│  │  │    • 周对比柱状图 (3周对比)                       │  │   │
│  │  │    • 险别组合占比 (饼图)                         │  │   │
│  │  │    • 业务员保费区间占比 (饼图)                   │  │   │
│  │  │    • 新转续占比 (饼图)                           │  │   │
│  │  └────────────────────────────────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              Pinia 状态管理层                             │   │
│  │  ┌──────────────────┐  ┌──────────────────────────────┐ │   │
│  │  │   filterStore    │  │     appStore                 │ │   │
│  │  │  ─────────────   │  │  ──────────────────          │ │   │
│  │  │ • activeFilters  │  │ • currentMetric              │ │   │
│  │  │ • filterOptions  │  │ • latestDate                 │ │   │
│  │  │ • dataScope      │  │                              │ │   │
│  │  │ • policyMapping  │  │                              │ │   │
│  │  │                  │  │                              │ │   │
│  │  │ → applyFilters() │  │ → switchMetric()             │ │   │
│  │  │ → resetFilters() │  │ → setLatestDate()            │ │   │
│  │  └──────────────────┘  └──────────────────────────────┘ │   │
│  │                                                             │   │
│  │  ┌──────────────────────────────────────────────────────┐ │   │
│  │  │          dataStore                                  │ │   │
│  │  │  ─────────────────                                 │ │   │
│  │  │ • kpiData, chartData, pieCharts...                 │ │   │
│  │  │ → fetchKpiData(), fetchChartData()                 │ │   │
│  │  │ → refreshPieCharts()                               │ │   │
│  │  └──────────────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
                              ↓ HTTP
┌─────────────────────────────────────────────────────────────────┐
│                    Flask 后端 (Python)                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │         api_server.py (路由层)                          │   │
│  │  ┌────────────────────────────────────────────────────┐  │   │
│  │  │ POST /api/kpi-windows                              │  │   │
│  │  │ POST /api/week-comparison                          │  │   │
│  │  │ GET  /api/filter-options                           │  │   │
│  │  │ GET  /api/policy-mapping                           │  │   │
│  │  │ POST /api/staff-performance-distribution           │  │   │
│  │  │ POST /api/pie-charts                               │  │   │
│  │  └────────────────────────────────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────────┘   │
│                              ↓                                    │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │      data_processor.py (业务逻辑层)                     │   │
│  │  ┌────────────────────────────────────────────────────┐  │   │
│  │  │ 核心方法：                                         │  │   │
│  │  │ • get_kpi_windows()      - KPI 三口径计算         │  │   │
│  │  │ • get_week_comparison()  - 周对比计算             │  │   │
│  │  │ • _apply_filters()       - 筛选逻辑 ⭐           │  │   │
│  │  │ • _apply_data_scope_filter() - 数据口径过滤       │  │   │
│  │  │ • get_filter_options()   - 筛选选项枚举           │  │   │
│  │  └────────────────────────────────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────────┘   │
│                              ↓                                    │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │         数据源                                            │   │
│  │  • 车险清单_2025年10-11月_合并.csv (55375 行)          │   │
│  │  • 业务员机构团队归属.json (映射文件)                 │   │
│  │  • premium_plan.json (未来扩展)                       │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 筛选流程图

### 用户侧筛选操作流程

```
┌─────────────────────────────────┐
│ 用户操作：选择"业务员"          │
└──────────────┬──────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│ FilterPanel 组件                        │
│ localFilters['业务员'] = 'xxx'          │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│ handleFilterChange('业务员')             │
│                                         │
│ if key === '业务员':                    │
│   const linked = resolveByStaff(staff)  │
│   localFilters['三级机构'] = linked.org │
│   localFilters['团队'] = linked.team    │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│ UI 自动禁用三级机构、团队下拉框         │
│ (CSS: disabled)                         │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│ 用户点击"应用筛选"按钮                  │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│ handleApplyFilters()                    │
│ 1. 过滤掉空值                           │
│ 2. 业务员联动补充机构/团队              │
│ 3. 调用 filterStore.applyFilters()     │
└──────────────┬──────────────────────────┘
               │
               ▼
┌──────────────────────────┐
│ filterStore 全局状态更新 │
│ activeFilters = {        │
│   '业务员': 'xxx',       │
│   '三级机构': 'yyy',     │
│   '团队': 'zzz'          │
│ }                        │
└──────────────┬───────────┘
               │
               ▼
┌──────────────────────────────┐
│ [watch triggered]            │
│ Dashboard 监听 activeFilters  │
│ 变化                         │
└──────────────┬───────────────┘
               │
               ▼
┌──────────────────────────────────────┐
│ refreshChartData()                   │
│ refreshPieChartsData()               │
└──────────────┬───────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│ 构建 API 请求载荷                       │
│ {                                       │
│   filters: {                            │
│     '业务员': 'xxx',                    │
│     '三级机构': 'yyy',                  │
│     '团队': 'zzz'                       │
│     ...                                 │
│   },                                    │
│   data_scope: 'exclude_correction'      │
│ }                                       │
└──────────────┬──────────────────────────┘
               │
               ▼ HTTP POST
      [发送到后端]
```

### 后端数据处理流程

```
┌────────────────────────────┐
│ 接收 POST 请求            │
│ /api/kpi-windows          │
└────────────┬───────────────┘
             │
             ▼
┌──────────────────────────────┐
│ 读取 CSV 数据               │
│ df = pd.read_csv(...)       │
│ (55375 行 × 76 列)          │
└────────────┬─────────────────┘
             │
             ▼
┌──────────────────────────────────┐
│ 第1步：应用数据口径过滤         │
│                                │
│ if data_scope == 'exclude_correction':
│   过滤出 '批单类型' 为空的行  │
│ else:                          │
│   保留所有行                   │
└────────────┬──────────────────┘
             │
             ▼
┌──────────────────────────────────┐
│ 第2步：应用业务筛选              │
│ _apply_filters(df, filters)     │
│                                │
│ 执行顺序：                      │
│ 1️⃣ 保单号 (unique id)          │
│ 2️⃣ 业务员 (通过工号查询)       │
│ 3️⃣ 三级机构 (通过映射反向)     │
│ 4️⃣ 团队 (通过映射反向)         │
│ 5️⃣ 是否续保                    │
│ 6️⃣ 是否新能源                  │
│ 7️⃣ 是否过户车                  │
│ 8️⃣ 是否异地车                  │
│ 9️⃣ 险种大类、吨位              │
└────────────┬──────────────────┘
             │
             ▼
┌──────────────────────────────────┐
│ 第3步：映射验证与校正            │
│ _validate_policy_consistency()   │
│                                │
│ 如果业务员在 CSV 中但不在     │
│ 映射文件中：记录警告           │
│ 如果映射冲突：以映射为准       │
└────────────┬──────────────────┘
             │
             ▼
┌──────────────────────────────────┐
│ 第4步：数据聚合计算              │
│                                │
│ 按机构/团队/业务员分组：       │
│ • sum(签单/批改保费)           │
│ • sum(签单数量)                │
│ • sum(手续费含税)              │
│ • 计算占比 (电销/新能源...)    │
└────────────┬──────────────────┘
             │
             ▼
┌──────────────────────────────────┐
│ 第5步：格式化返回结果            │
│                                │
│ {                              │
│   success: true,               │
│   data: {                      │
│     premium: {...},            │
│     policy_count: {...},       │
│     commission: {...},         │
│     ratios: {...},             │
│     validation: {...}          │
│   }                            │
│ }                              │
└────────────┬──────────────────┘
             │
             ▼ HTTP 200
      [返回前端]
```

---

## 状态流向图

```
用户输入
  │
  ▼
FilterPanel (localFilters)
  │
  ├─ handleFilterChange()
  │  └─ [业务员 → 自动联动机构/团队]
  │
  ▼
handleApplyFilters()
  │
  ├─ 验证 activeFilters 变化
  │
  ▼
filterStore.applyFilters()
  │
  ├─ updateState: activeFilters = {...}
  │
  ▼
[watch: activeFilters]  ◄─── Dashboard.vue 监听
  │
  ▼
refreshChartData()
  │
  ├─ getActiveFilters()    ─┐
  ├─ getDataScope()         ├─► 构建载荷
  ├─ currentMetric()        ─┘
  │
  ▼
dataStore.fetchKpiData()
dataStore.fetchChartData()
dataStore.refreshPieCharts()
  │
  ├─ POST /api/kpi-windows
  ├─ POST /api/week-comparison
  ├─ POST /api/pie-charts
  │
  ▼
后端处理
  │
  ├─ _apply_filters()
  ├─ _apply_data_scope_filter()
  ├─ 数据聚合计算
  │
  ▼
返回 JSON 结果
  │
  ▼
前端更新 store 的数据状态
  │
  ├─ kpiData
  ├─ chartData
  ├─ pieCharts
  │
  ▼
[computed] kpiCards, chartData, etc.
  │
  ▼
视图重新渲染
  │
  ├─ KpiCard 更新显示
  ├─ ChartView 重绘图表
  ├─ PieChartCard 更新占比
  ├─ 筛选标签更新
```

---

## 联动关系详细图

### 业务员 ↔ 机构/团队 联动

```
选择业务员
    │
    ▼
resolveByStaff(name)
    │
    └─► 读取 staff_mapping (业务员机构团队归属.json)
            │
            └─► { org: '三级机构', team: '团队简称' }
                    │
                    ▼
            自动填充:
            - localFilters['三级机构']
            - localFilters['团队']
                    │
                    ▼
            禁用这两个字段的手动修改
            (UI: disabled="true")
```

### 机构 ← → 团队 联动

```
方向 1: 选择机构 → 动态过滤团队

  选择三级机构
    │
    ▼
  filterStore.teamOptions (computed)
    │
    ├─ filterOptions['机构团队映射'][selectedOrg]
    │   └─► 仅返回该机构对应的团队
    │
    ▼
  FilterPanel 中的团队下拉框动态更新
  (options 绑定到 teamOptions computed)

方向 2: 选择业务员 → 自动确定机构和团队

  选择业务员
    │
    ▼
  resolveByStaff()
    │
    ├─ 读取该业务员的机构和团队信息
    │
    ▼
  自动填充三级机构和团队字段
  并禁用手动修改
```

---

## 关键字段映射关系

```
CSV 数据列
│
├─ 保单号 (唯一标识)
│  └─► 后端: policyMapping['policy_to_staff']
│      └─► 业务员
│          └─► 后端: policyMapping['staff_to_info']
│              └─► { 三级机构, 四级机构, 团队简称 }
│
├─ 业务员 (可选筛选)
│  └─► 后端: staff_mapping (业务员机构团队归属.json)
│      └─► { 三级机构, 四级机构, 团队简称 }
│          └─► 用于:
│              ├─ 过滤与之关联的所有保单
│              └─ 自动填充组织结构
│
├─ 三级机构 (后台维护)
│  └─► inst_team_map
│      └─► 团队列表 (该机构下的所有团队)
│
├─ 团队 (后台维护)
│  └─► 对应机构中的子队伍
│
├─ 是否续保
│  └─► 新保 | 续保 | 转保 (3值)
│
├─ 是否新能源
│  └─► 是 | 否
│
├─ 是否过户车
│  └─► 是 | 否
│
├─ 是否异地车
│  └─► 是 | 否
│
├─ 终端来源
│  └─► 0110融合销售 (用于识别电销)
│
├─ 签单/批改保费
│  └─► 数值，用于保费聚合与占比计算
│
└─ 吨位分段
   └─► 1吨以下 | 1-2吨 | ... | 10吨以上
```

