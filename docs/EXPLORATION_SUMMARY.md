# 筛选器架构探索 - 完整总结

## 探索范围与成果

本次探索对车险签单数据分析平台的筛选器架构进行了 **全面、深入的调查分析**，涵盖前端UI、状态管理、后端API和数据处理的全栈范围。

### 生成的文档
1. **FILTER_ARCHITECTURE.md** (12KB)
   - 完整的筛选器架构详解
   - 包含10个章节，逐层分析系统设计
   
2. **FILTER_QUICK_REFERENCE.md** (5.1KB)
   - 快速参考指南
   - 表格、代码示例和常见问题排查
   
3. **FILTER_VISUAL_GUIDE.md** (24KB)
   - 可视化架构和流程图
   - 系统架构、数据流、状态转移等图示

---

## 关键发现

### 1. 筛选维度数量与范围
- **当前实现：8个筛选维度**（实际9个，含业务员）
  
| # | 维度 | 状态 | 联动 | 说明 |
|---|------|------|------|------|
| 1 | 业务员 | ✓ | 主维度 | 选择后自动确定机构/团队 |
| 2 | 三级机构 | ✓ | ← → | 与业务员/团队有双向联动 |
| 3 | 团队 | ✓ | ← → | 依赖机构或业务员选择 |
| 4 | 是否续保 | ✓ | 独立 | 新保/续保/转保 (3值) |
| 5 | 是否新能源 | ✓ | 独立 | 是/否 |
| 6 | 是否过户车 | ✓ | 独立 | 是/否 |
| 7 | 是否异地车 | ✓ | 独立 | 是/否 (新增, 2025-11-09) |
| 8 | 险种大类 | ✓ | 独立 | 当前仅车险 |
| 9 | 吨位 | ✓ | 独立 | 1吨-10吨+ (6档) |

### 2. 指标切换的独立性
- **全局指标切换 (Premium ↔ Count) 与筛选完全解耦**
- 指标只影响数据聚合方式，不改变筛选条件
- 前端工具栏统一控制，所有组件独立消费

### 3. 三层筛选体系
```
UI层        ► FilterPanel.vue      (用户交互)
             ↓
业务层      ► filter.js (Pinia)   (状态管理)
             ↓
数据层      ► data_processor.py   (实际过滤)
             ↓
数据源      ► CSV + JSON映射文件
```

### 4. 关键技术特点

#### 业务员是唯一主筛选维度
- 选择业务员后，自动通过映射文件确定所属机构和团队
- 自动禁用机构/团队的手动修改
- 防止组织结构不一致

#### 联动防护机制
1. **业务员 → 机构/团队**：自动联动
2. **机构 → 团队**：动态过滤
3. **机构选择后禁用团队**：防止错误组合
4. **映射冲突自动校正**：以映射文件为准

#### 数据口径独立传递
- `exclude_correction` (默认)：仅正常承保
- `include_correction`：包含批改/退保
- 与筛选条件分离，独立传给所有API

### 5. 业务类型字段分析

**重要发现：CSV 中不存在直接命名为"业务类型"的字段**

但功能上由以下字段组合实现：
- **是否续保** (主要使用)：新保/续保/转保 (3值)
- **车险新业务分类**：目标业务/管控业务/清亏业务/其他 (4值)
- **终端来源**：用于识别电销渠道 (7种来源)
- **新旧车标志**：N新车/O旧车

**未来规划**：
- 若需增加"业务类型"，应在 premium_plan.json 中定义
- 建立与保费计划的对应关系
- 然后在筛选器中添加该维度

### 6. 后端API能力

**支持的筛选参数** (9个维度)
```javascript
{
  filters: {
    '业务员', '三级机构', '团队',
    '是否续保', '是否新能源', '是否过户车',
    '是否异地车', '险种大类', '吨位'
  },
  data_scope: 'exclude_correction' | 'include_correction'
}
```

**实现位置**：
- 后端：data_processor.py::_apply_filters() (line 907)
- 执行顺序：保单号 → 业务员 → 机构 → 团队 → 其他维度

---

## 架构对标

### 与市场主流平台对比
| 方面 | 本项目 | 行业典型 | 评价 |
|------|------|--------|------|
| 筛选维度数 | 9个 | 6-12个 | 中等 ✓ |
| 联动机制 | 三级 | 通常二级 | 较强 ✓✓ |
| 数据口径隔离 | 完全分离 | 多数集成 | 优秀 ✓✓✓ |
| 映射管理 | JSON文件 | 通常DB | 灵活 ✓ |
| 指标与筛选解耦 | 完全分离 | 混合 | 优秀 ✓✓✓ |

---

## 代码位置索引

### 前端关键文件
```
/frontend/src/components/dashboard/FilterPanel.vue    (筛选UI, 741行)
/frontend/src/stores/filter.js                        (筛选状态管理, 310行)
/frontend/src/views/Dashboard.vue                     (使用者, 765行)
/frontend/src/stores/data.js                          (数据加载)
/frontend/src/stores/app.js                           (全局应用状态)
```

### 后端关键文件
```
/backend/api_server.py                                (API路由)
  - POST /api/kpi-windows
  - POST /api/week-comparison
  - GET  /api/filter-options
  - GET  /api/policy-mapping
  - POST /api/staff-performance-distribution

/backend/data_processor.py                            (业务逻辑, 1600+行)
  - get_filter_options()        (line 354)
  - _apply_filters()            (line 907) ⭐
  - _apply_data_scope_filter()  (line 891)
  - get_policy_mapping()        (line 60)
```

### 配置数据文件
```
/业务员机构团队归属.json          (业务员→机构/团队映射)
/车险清单_2025年10-11月_合并.csv  (55375行, 76列原始数据)
```

---

## 数据流总结

### 完整流程
```
用户操作 (FilterPanel)
  ↓ 业务员→自动联动机构/团队
  ↓
应用筛选 (handleApplyFilters)
  ↓
filterStore.applyFilters() [全局状态更新]
  ↓ watch triggered
Dashboard 监听
  ↓
refreshChartData() / refreshPieChartsData()
  ↓
构建请求载荷 {filters, data_scope}
  ↓ HTTP POST
后端 API 接收
  ↓
_apply_data_scope_filter()        [第1步]
  ↓
_apply_filters()                  [第2步]
  ↓
_validate_policy_consistency()    [第3步]
  ↓
数据聚合计算                       [第4步]
  ↓
返回 JSON
  ↓
前端更新 store (kpiData, chartData, etc)
  ↓ computed trigger
视图重新渲染 (KPI/图表更新)
```

---

## 关键设计原则

### 1. 映射驱动
- 所有组织结构 (机构/团队) 由 JSON 映射文件驱动
- CSV 数据中的业务员仅用于关联，实际应用以映射为准
- 映射冲突时，自动校正为映射值

### 2. 联动保护
- 业务员是唯一"信源"，确定机构和团队
- 机构选择后，团队动态过滤
- 防止用户手工选择不一致的组合

### 3. 口径隔离
- 筛选条件与数据口径分离
- 两者独立传递，互不干扰
- 允许用户在保持筛选条件的同时切换数据口径

### 4. 弱耦合指标
- 指标切换只改变数据聚合维度
- 所有筛选和组件完全独立
- 支持快速指标切换而无需重新筛选

---

## 常见问题Q&A

### Q1: 为什么没有"业务类型"筛选维度？
**A:** CSV 数据中不存在该字段，但功能上由"是否续保"和"终端来源"实现。若需要，应在 premium_plan.json 中定义，然后建立与保费计划的对应关系。

### Q2: 业务员选择后，为什么机构/团队字段被禁用？
**A:** 防止用户选择与业务员不符的机构/团队，确保数据一致性。后端以映射文件为准，手工修改会被忽略。

### Q3: 指标切换 (Premium/Count) 会不会清除筛选条件？
**A:** 不会。两者完全独立。指标切换只改变数据聚合方式，筛选条件保持不变。

### Q4: 数据口径和筛选条件的区别？
**A:** 
- 筛选条件：选择查看哪些**具体记录** (如特定业务员、机构等)
- 数据口径：选择**如何统计**这些记录 (含或不含批改)

### Q5: 如何添加新的筛选维度？
**A:** 
1. 确认 CSV 中有对应字段
2. 在 get_filter_options() 中追加维度的取值
3. 在 FilterPanel.vue 中添加 select 框
4. 在 _apply_filters() 中实现过滤逻辑
5. 测试端到端流程

---

## 性能与可扩展性评估

### 当前性能指标
- **数据量**：55,375 行 × 76 列
- **筛选维度**：9个
- **筛选选项数**：~200-300 个
- **API 响应时间**：预估 200-500ms (单筛选)

### 可扩展性评估
| 方面 | 评价 | 建议 |
|------|------|------|
| 筛选维度数 | 中等 | <15个时无压力 |
| 数据量 | 可接受 | >100K行时考虑分页 |
| 联动层级 | 良好 | 当前三级最优 |
| 映射文件 | 可维护 | 机构<100时无问题 |

---

## 文档导航

### 快速入门
→ **FILTER_QUICK_REFERENCE.md** (5分钟)

### 完整学习
→ **FILTER_ARCHITECTURE.md** (20分钟)

### 可视化理解
→ **FILTER_VISUAL_GUIDE.md** (15分钟)

### 本文档
→ **当前文件** (总结概览, 10分钟)

---

## 下一步建议

### 立即可做 (1-2天)
- [ ] 阅读快速参考指南
- [ ] 在本地运行筛选流程进行端到端测试
- [ ] 验证业务员→机构/团队的联动是否符合实际

### 短期计划 (1-2周)
- [ ] 补充"业务类型"维度 (若业务需要)
- [ ] 优化数据口径切换的性能
- [ ] 添加筛选条件保存/快捷组合功能

### 中期计划 (1-3个月)
- [ ] 实现保费计划管理 (premium_plan.json)
- [ ] 添加保单详情查询接口
- [ ] 支持自定义筛选维度配置

---

## 附录：技术栈

| 层级 | 技术 | 版本 |
|------|------|------|
| 前端框架 | Vue 3 | 3.x |
| 状态管理 | Pinia | 最新 |
| 构建工具 | Vite | 最新 |
| 图表库 | ECharts | 5.x |
| 后端框架 | Flask | 2.x |
| 数据处理 | Pandas | 1.x |
| 配置管理 | JSON | - |

---

**文档版本**：1.0  
**最后更新**：2025-11-09  
**维护者**：开发团队

