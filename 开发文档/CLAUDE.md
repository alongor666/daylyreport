# 开发规范要点（镜像）

> 本文件为根目录 `CLAUDE.md` 的关键要点镜像，强调本迭代新增约束。

## 新增约束（保单号为唯一筛选维度）

- 前端筛选新增“保单号”，选择后自动联动“业务员/三级机构/团队”，并锁定以映射为准。
- 后端过滤统一按 `业务员机构团队归属.json` 校验与覆盖冲突值。
- 新增 `GET /api/policy-mapping` 供前端加载映射依赖。
- 仪表盘显示 `policy_consistency.mismatch_count` 作为不一致提示。
 - 前端函数级中文注释要求：组件与方法需通过中文注释标注用途与输入输出。

## 前端组件改动与中文注释要求（2025-11-09）
- 组件扩展：
  - `KpiCard.vue` 增加 `valueType: 'percent'`，统一百分比显示为 `XX.X%`；保留既有 `wanInt/number/currency`。
  - `Dashboard.vue` 的 `kpiCards` 追加四张占比类卡片（电销/新能源/过户车/交强险），数据源读取 `dataStore.kpiData.ratios.*`；既有卡片与布局不改动。
- 注释要求：
  - 在 `KpiCard.vue` 的格式化函数与新 `valueType` 处添加函数级中文注释，说明输入、输出与边界（分母为0返回0，范围裁剪至 `[0,1]`）。
  - 在 `Dashboard.vue` 的 `kpiCards` 生成逻辑处添加中文注释，说明弱耦合设计（仅读取 `store` 的新字段，不影响既有键与渲染）。
- 交互与健壮性：
  - 切换“数据口径”与筛选器通过 `filterStore.getDataScope()` 与现有 `filters` 传入请求；不新增全局状态，避免耦合。
  - 前端计算不做二次兜底，百分比值来源于后端，组件仅负责显示与格式化。

## 开发检查

- 对筛选逻辑进行冒烟测试：选择不同保单号应得到唯一数据子集且一致。
- 更新映射文件后，刷新筛选选项与映射，行为保持一致。
 - 预览筛选面板UI，验证禁用态与提示文案符合设计与PRD。
- 预览周对比趋势图：
  - 动态标签采用紧凑样式：主值后显示“箭头 + 变化值 + 变化率”，不使用冗长状态文案。
  - 颜色阈值检查：增长率 `> +5%` 为上升色；`< -5%` 为下降色；其余为中性色。
  - 布局检查：tooltip 行应为 5 列网格（色点/日期/当期值/变化/变化幅度），三数值列固定宽度并居中对齐。
  - 图例（仅UI显示）使用中文：当周 / 上周 / 上上周。实现必须保持内部语义代码使用 `D` / `D-7` / `D-14`，不得用于计算或数据结构替换。
  - 悬停行为检查：悬停某星期几时，应出现三行（D-14、D-7、D）对应日期的数据；D-14 行“较7天前”应显示“无对比”。

> 备注：`ChartView.vue` 已添加函数级中文注释，包含 tooltip 格式化器说明。

### 单位与布局（2025-11-09）
- 单位规范：保费相关指标统一采用“万元整数”显示（KPI 与周对比图一致），避免单位切换造成理解负担。
- 组件实现：
  - `ChartView.vue`：`formatNumber` 在 `currentMetric==='premium'` 分支下按“万元整数”格式化；tooltip 行布局改为 6 列，箭头单独一列，列间距与行距上调。
  - `KpiCard.vue`：新增 `valueType: 'wanInt'`，用于保费/佣金/目标差距的万元整数显示；`Dashboard.vue` 为相关卡片设置该类型。
- 验收提示：预览中核对 KPI 卡主值与周对比图轴/tooltip 的单位一致；单量指标仍以数字千分位显示。

### 渠道判定规则（2025-11-09）
- 认定口径：以 `终端来源` 为唯一依据，取值 `0110融合销售` 认定为“电销”，其余为“非电销”。
- 后端实现建议：
  - 聚合层输出布尔 `is_telesales` 与占比（保费/单量）；保费建议使用 `签单/批改保费`，允许负值与批改项进入口径；单量建议使用 `签单数量`。
  - 提供用于核对但不参与认定的字段：`业务来源` 与 `客户源`，前端用于数据一致性检查。
- 前端实现建议：
  - 新增电销相关 KPI 卡片（占比/保费/单量）；保费用 `wanInt` 显示；联动与筛选逻辑维持不变。
  - 组件注释：在新增/修改的 KPI 组件与格式化函数处添加函数级中文注释，说明电销判定的口径与展示单位。
- 验收与核对：
  - 抽样 `终端来源=0110融合销售` 的记录，检查布尔映射与占比计算正确；
  - 对比包含“(电销)”字样的 `业务来源/客户源`，记录差异并在问题记录表中解释原因与口径选择。

## 数据字典工具

- 新增脚本：`scripts/csv_field_profiler.py`，用于分析 CSV 字段类型/格式/值域并生成 Markdown 文档；所有函数已按要求添加中文注释。
- 运行方式：`python3 scripts/csv_field_profiler.py [input_csv] [output_md]`；默认分析根目录文件并输出至 `开发文档/`。
- 检查点：
  - 文本列取值穷举是否完整（用于前端枚举与数据治理）；
  - 日期列格式是否统一（含时间/不含时间混用需治理）；
  - 数值/货币/百分比识别是否符合预期（含千分位、币种符号）。

### 隐私与合规
- 文档生成时对敏感字段隐藏“文本明细穷举”：被保险人、投保人、车牌号码/车牌号/号牌号码、车架号码/车架号/VIN、发动机号码/发动机号、批单号、续保单号。
- 隐藏后仍保留统计信息（类型/格式/长度范围/缺失率）以支持质量分析与规则校验。
- 最新更新：敏感字段的章节不再生成（永久删除），数据字典中不包含对应条目；脚本已实现章节级跳过。
- 新增敏感字段：行驶证车主（含同义词：行驶证持有人/行驶证所有人），随生成流程自动删除章节。
 - 细粒度策略：对“客户名称”保留章节但屏蔽文本明细，生成时输出隐私提示以替代明细穷举。

## 启动检查
- 后端：`backend/api_server.py` 启动于 `http://localhost:5001`，健康检查返回 `{"status":"healthy"}`。
- 前端：`npm run dev` 启动 Vite 于 `http://localhost:3000/`，可正常打开预览。
- 端口占用：如遇 5001 被占用，先使用 `lsof -i :5001` 与 `kill <PID>` 释放端口，再启动后端。
 - 根路径：访问 `http://127.0.0.1:5001/` 应返回静态首页（或接口说明），避免404；已通过 `static_folder` 配置与 `/` 路由实现。

## 日期筛选与去重向量化规范（2025-11-09）

- 日期比较（按天口径）：
  - 必须使用 `Series.dt.normalize()` 对齐到“日”再比较，例如：`mask = df['投保确认时间'].dt.normalize() == anchor.normalize()`；区间比较同理，统一在“日”粒度构造掩码。
  - 禁止使用 `Series.dt.date` 与 `datetime.date()` 混合比较（会产生 Python `date` 与 `NaT/时区` 混用问题）。
- 星期索引：
  - 使用向量化 `Series.dt.dayofweek`（周一=0）进行分组/对齐，替换标量 `datetime.weekday()` 与对单元格 `apply(lambda ...)` 的计算；用于 `get_week_trend/get_week_comparison` 等周窗口逻辑。
- 去重策略：
  - 使用 `Series.duplicated(subset=..., keep='first'|'last')` 生成掩码后反选，替换 `DataFrame.drop_duplicates(...)`，以规避混合类型列的潜在类型报错。
  - 业务口径保持：
    - 映射表（保单→业务员）保留首条（`keep='first'`）。
    - 历史合并（保单+投保确认时间）保留最新一条（`keep='last'`）。
- 注释与契约：
  - 涉及日期/周窗口/去重的函数必须添加函数级中文注释，明确：用途、入参/出参、边界（分母为0、NaT/时区）、错误处理策略与返回结构稳定性。
  - 前后端契约中，星期索引与窗口标签的内部语义仅使用 `D` / `D-7` / `D-14`，UI 图例中文不参与计算与数据结构替换。

## 诊断修复记录（后端参数校验与错误处理） — 2025-11-08

- 路由 `POST /api/staff-performance-distribution` 增强入参校验：
  - `period` 必须为字符串，归一化为小写后需属于白名单 `{day, last7d, last30d}`；否则返回 400。
  - `filters` 必须为对象（JSON 字典）；否则返回 400。
- 错误返回规范：统一返回 `success: false` 与明确的 `message`；当 `period` 非法时额外返回 `allowed` 列表用于前端提示。
- 函数级中文注释：在路由函数注释中说明校验目的（尽早拦截无效入参、减少后端处理与 IDE 报错来源）。
- 冒烟验证：
  - 非法 `period=week`：HTTP 400，JSON 包含 `message: "参数错误: period 仅支持 day/last7d/last30d"` 与 `allowed` 列表；
  - 合法 `period=day` 且 `filters={}`：HTTP 200，返回分布数据结构。
- 目的：避免因入参类型/取值异常导致的未定义变量与类型不匹配告警，提升接口健壮性与可诊断性。
---
诊断修复记录（2025-11-08 21:05）

1) 修复前端趋势类型告警
- 问题：KpiCard.vue 的 `trend` Prop 期望 `Number`，但 Dashboard.vue 的 `calculateTrend` 返回 `String`（toFixed）。

## 占比类KPI开发规范（已实施） — 2025-11-09

- 后端：
  - 在 `backend/data_processor.py:get_kpi_windows` 中统一应用 `data_scope` 过滤（与 `get_week_comparison` 一致）。
  - 新增占比计算并返回 `ratios` 字段（函数级中文注释必备）：
    - `ratios.telesales.premium/count`、`ratios.new_energy.count`、`ratios.transfer.count`、`ratios.mandatory.premium`；
    - 分母为 0 返回 0.0，比例裁剪至 `[0,1]`，异常值防护完备。
- 前端：
  - `KpiCard.vue` 增加 `valueType: 'percent'`，百分比显示保留 1 位小数；异常值裁剪。
  - `Dashboard.vue` 在 `kpiCards` 中新增四张占比卡，数据来自 `dataStore.kpiData.ratios.*`，趋势与折线逻辑复用。
  - `stores/data.js` 对所有请求载荷注入 `data_scope`，保证口径切换一致性。
- 验收：
  - 切换数据口径后占比卡同步变化；抽样核对分子匹配规则（电销/新能源/过户车/交强险）。
  - UI 预览通过（百分比 `XX.X%`），与格式规范一致。
- 修复：统一 `calculateTrend` 返回数字类型（`parseFloat(...toFixed(1))`），并添加函数级中文注释说明原因与计算逻辑。
- 影响：消除 Vue Invalid prop 警告；趋势显示逻辑保持不变。

## 新增约束（商业险/异地车占比 + 异地车筛选） — 2025-11-09

- 后端实现约束：
  - 在 `backend/data_processor.py` 新增掩码函数 `_mask_commercial` 与 `_mask_non_local`，用于识别商业险与异地车；函数需添加中文注释，说明判定口径与字段来源。
  - 在 `get_kpi_windows` 中新增 `ratios.commercial` 与 `ratios.non_local` 两类占比，分别支持 `premium/count` 两种口径（商业险以保费为主；异地车支持保费与件数）。
  - 在 `get_filter_options` 返回筛选项“是否异地车”（取值：`全部/是/否`），并在 `_apply_filters` 应用该项过滤；函数需添加中文注释，明确取值、边界与空值处理。

- 前端实现约束：
  - 在 `Dashboard.vue` 新增两张 KPI 卡：“商业险占比”“异地车占比”，以百分比显示并随 `appStore.currentMetric` 全局口径联动；卡片生成逻辑与绑定需添加函数级中文注释。
  - 在 `FilterPanel.vue` 新增“是否异地车”筛选项，下拉选项由后端返回动态渲染；交互与载荷传递沿用既有布尔型选项模式（是/否/全部）。

- 口径与健壮性规范：
  - 比例计算分母为 0 时返回 0.0；结果裁剪至 `[0,1]`；所有相关函数需以中文注释明确异常值策略。
  - 保费单位显示遵循“万元整数”规范；件数按数字千分位显示。

- 验收说明：
  - 切换“保费/客户数”后，两张新卡按口径正确刷新；选择“是否异地车”为“是/否”后，KPI 与明细联动变化；“全部”不影响筛选结果。
  - 文档（README/PRD-best/PROGRESS/问题记录表）需同步更新本次新增内容与口径说明。

## 筛选维度与联动规范（2025-11-09 新增）

- 入口变更：筛选入口从“保单号”切换为“业务员”；保单号保留为后端关联与校验使用，不直接作为 UI 可见维度。
- 联动规则：
  - 当选择“业务员”时，自动归一化其所属“团队/三级机构”，并在控件层面禁用后续对“团队/三级机构”的手动修改；
  - 若后端映射存在冲突或缺失，返回 `ambiguity/unmatched_staff` 标记，前端以 Banner 告警并记录问题表。
- 数据层接口：
  - `filterStore.resolveByStaff(name)`：根据业务员姓名解析并归一化团队与机构；
  - `filterStore.applyFilter()`：在应用筛选时整合当前选择与联动归一化的值；
  - 两函数均需添加函数级中文注释，明确用途、入参/出参与副作用（状态更新）。
- 全局指标联动：
  - `appStore.switchMetric(metric)` 为唯一入口，`ChartView/Dashboard/KpiCard` 等组件仅消费 `currentMetric`；
  - 占比类 KPI 通过 `kpiData.ratios.*[currentMetric]` 实现弱耦合集成。
- 错误处理策略：
  - 前端不做二次校正，所有归一化与冲突裁决以后端映射/规则为准；
  - 日志：在数据层打印请求载荷与状态码/响应体，便于诊断；避免在 UI 层进行复杂判断。

2) 端口与代理配置环境化
- 问题：Vite 端口与代理目标硬编码，后端启动提示硬编码 `5173`，导致端口不一致与混淆。
- 修复：
  - 前端：`vite.config.ts/js` 读取 `.env` 的 `VITE_PORT` 与 `VITE_API_TARGET`；新增 `frontend/.env.example` 与 `frontend/.env.development`（默认 `3000` / `http://localhost:5001`）。
  - 后端：`api_server.py` 根路径 `preview` 与启动提示读取 `FRONTEND_URL` 或 `VITE_PORT` 动态输出；API 端口读取 `API_PORT/PORT`。
- 影响：避免硬编码，前后端端口可按环境灵活配置；文档与提示统一。

3) 错误日志增强
- 前端：`stores/data.js` 在 `fetchKpiData` 与 `fetchChartData` 的 `catch` 中增加状态码、响应体与请求载荷输出，便于快速定位 `AxiosError`（如 400 入参不合法）。

验证结果
- 周对比接口 `POST /api/week-comparison` 本地 `curl` 成功，返回包含 `x_axis` 与 `series` 的数据；KPI与图表并行加载成功。
- Vue 控制台已不再出现 `trend` 类型告警。

后续建议
- 若更改端口，请同步更新 `.env.development` 并重启前端。
- 后端若变更端口，建议设置 `API_PORT` 环境变量并重启服务。

---
诊断修复记录（2025-11-08 21:30）

4) 作用域修复与后端接口验证
- 问题：`frontend/src/stores/data.js` 在 `catch` 中访问 `payload` 导致 `ReferenceError`（因 `payload` 在 `try` 内声明）；同时前端报多个 500。
 - 修复：将 `payload` 提升至函数级作用域，在 `catch` 中安全打印；保留更详细的 Axios 错误日志（状态码、响应体、载荷）。
 - 后端：确认 Flask 未启动是 500 的主要原因之一，启动 `python3 backend/api_server.py` 后接口恢复正常；端口支持 `API_PORT`/`PORT` 环境变量。
 - 验证：`GET /api/filter-options` / `POST /api/kpi-windows` 正常返回；前端控制台不再出现 `payload 未定义` 与 500。
 - 建议：前后端同时启动；如调整端口/代理目标请同步 `.env` 并重启服务。

---
新增约束与弱耦合规范（置顶工具栏 + 全局指标） — 2025-11-09

目标
- 前端统一在 `Dashboard.vue` 置顶工具栏提供全局指标切换（`currentMetric: 'premium' | 'count'`），并作为所有图表与KPI的单一数据源；避免各子组件重复维护本地切换状态。
- 筛选维度默认改为“业务员”，保单号作为唯一标识用于后端数据关联，但不暴露为用户可见的筛选入口（隐私与口径一致性）。

前端组件变更
- `Dashboard.vue`：新增全局指标切换区（按钮/Segment），与日期/数据范围并列于置顶工具栏；通过 `useAppStore.switchMetric(metric)` 变更全局状态。
- `ChartView.vue`：移除局部指标切换 UI，改为仅消费 `appStore.currentMetric`；监听其变化触发数据刷新（watch/computed）。
- `FilterPanel.vue`：将“保单号”筛选入口替换为“业务员”筛选入口；当选择业务员时，自动联动 `团队`/`三级机构`，并在后端载荷中携带一致的维度映射。

状态与接口契约
- `useAppStore` 必须暴露：
  - `currentMetric: 'premium' | 'count'`
  - `switchMetric(metric)` 切换全局指标
  - `dataScope`/`dateRange` 等现有字段保持不变
- 前端请求载荷统一包含：
```json
{
  "metric": "premium | count",
  "filters": {
    "salesperson": "业务员姓名",
    "team": "团队",
    "org3": "三级机构",
    "is_renewal": true
  },
  "date_range": ["2025-11-01", "2025-11-09"],
  "data_scope": "daily | weekly | monthly"
}
```
- 后端需保证保单号唯一性用于内部关联，不作为筛选维度直接暴露；若存在映射冲突（如一个保单对应多个业务员），返回 `ambiguity: true` 并提供 `conflicts` 列表，前端以 `WarnBanner` 告警。

函数级中文注释要求
- 所有新增/修改的函数都需添加中文函数注释，说明：用途、入参、出参、副作用/触发的状态变更、错误处理策略。示例：
```js
/**
 * 函数用途：切换全局指标（保费/客户数），触发相关组件刷新。
 * 入参：metric - 指标类型，'premium' 或 'count'。
 * 出参：无；通过全局状态更新产生副作用。
 * 副作用：更新 appStore.currentMetric；触发 watch/computed 的数据重新请求。
 * 错误处理：无（入参由 UI 限定）；如扩展为动态枚举需在此校验。
 */
function switchMetric(metric) { /* ... */ }
```

## 新增约束（清亏业务占比） — 2025-11-09

- 后端实现约束：
  - 在 `backend/data_processor.py` 新增掩码函数 `_mask_loss_business`，依据字段 `车险新业务分类` 判定“清亏业务”的样本集合；函数需添加中文注释，明确用途、入参（DataFrame 与字段名）、出参（布尔掩码）与边界（空值/大小写/空白字符处理）。
  - 在 `get_kpi_windows` 计算并返回 `ratios.loss_business`，同时支持 `premium/count` 双口径与三窗口 `{ day, last7d, last30d }`；分母为 0 返回 0.0，比例裁剪至 `[0,1]`；相关聚合辅助函数需添加中文注释（输入/输出/异常值策略）。

- 前端实现约束：
  - 在 `frontend/src/views/Dashboard.vue` 新增“KPI 卡：清亏业务占比”，数据绑定到 `dataStore.kpiData.ratios.loss_business[appStore.currentMetric]`，百分比显示保留 1 位小数；卡片生成与联动逻辑需添加中文注释（弱耦合、仅消费 store 字段，不破坏既有结构）。
  - 卡片随全局 `appStore.currentMetric` 在 `premium/count` 两口径间切换；与 Day/7D/30D 三窗口的迷你折线保持一致的生成与显示逻辑。

- 验收与健壮性：
  - 抽样核对：`车险新业务分类=清亏业务` 的样本作为分子；分母为当前数据范围内的总保费/总件数（按口径）。
  - 分母为 0 时返回 0.0；比例统一裁剪至 `[0,1]`；前端不做二次兜底，仅格式化显示。
  - 文档（README/PRD-best/PROGRESS/问题记录表）需同步记录本指标的口径与契约，保持与其他占比类 KPI 一致。

隐私与展示规范
- 保单号仅用于后端数据关联，不在 UI 直接显示或作为筛选项；如确需展示（内部审计），需在 `AppPrivacy.md` 记录并加掩码显示。
- 保费相关单位统一为“万元整数”，图表轴与 tooltip 保持一致；客户数使用自然数。

验收与预览
- 修改后需在本地开发服务器预览，检查：
  - 全局切换是否联动所有 KPI 与图表
  - “业务员”筛选是否正确联动团队/三级机构
  - 无局部指标切换残留，无重复状态源
  - 请求载荷携带 `metric` 与筛选一致
### 约束补充（2025-11-09）
- 监控指标的占比必须同时提供 `count` 与 `premium` 两种口径，后端以统一契约返回，前端仅负责切换与展示（弱耦合）。
- 单交识别以“险别组合=单交”为主规则，必要时回退到“仅交强险不含商险”的判定；新保占比以 `是否续保=新保` 为唯一来源。
- 当分母为 0 或数据缺失时，所有占比值统一按 0 返回，避免前端异常（鲁棒性）。
- 核心KPI的目标分解采用 ARCHITECTURE.md 15.1 的 43100 设定与分解公式，颜色规则按 PRD-best.md 执行。
### 约束更正（2025-11-09 晚）
- 监控指标后端必须同时返回 `count` 与 `premium`；前端默认展示 `premium`，切换到 `count` 不需要确认但需提供视觉反馈。
- 单交识别仅以“险别组合=单交”为准，取消任何回退识别逻辑。
- `是否续保` 值域为 `新保/转保/续保`；新保占比的识别值为 `新保`。

### 口径与标签更正（2025-11-09 晚）
- 全局标签：将“客户数”统一更名为“件数”，与 PRD/README/问题记录表一致，避免术语歧义。
- 双口径契约：`get_kpi_windows.ratios.*` 必须同时返回 `premium/count`；新增 `single_mandatory` 与 `new_policy` 两类占比遵循同约束。
- 视觉统一：全局指标切换按钮样式需与筛选控件一致（默认/悬停/选中），并提供明显的选中高亮反馈。

## Dashboard 分区实现约束（核心KPI/监控占比/计划达成）— 2025-11-09 晚

- 分区与标题：
  - 核心KPI（标题：核心KPI）：仅三张卡（保费/单量/佣金）；任何新增核心指标需经 PRD 评审后调整，不得越权扩展。
  - 监控占比（标题：监控占比）：占比类卡片统一消费 `kpiData.ratios.*[currentMetric]`，不得在前端自行拼公式；值域统一裁剪 `[0,1]`。
  - 计划达成（标题：计划达成）：默认显示“目标差距”；当 `plan_exists=true` 时追加“保费达成率/保费缺口”。
- 代码结构：
  - 抽取辅助函数 `generateSparklineData/calculateTrend/getCurrentValue` 于模块级（函数级中文注释），供各分区复用。
  - 将 `kpiCards` 作为统一卡片工厂，分区列表通过 `coreKpiCards/ratioKpiCards/planKpiCards` 进行筛选与追加，不打破既有数据结构。
- 验收约束：
  - 页面出现三个中文分区标题；核心KPI仅三张卡；计划命中时显示达成率/缺口，未命中不展示占位。
  - 切换 `currentMetric/currentPeriod` 时各分区卡片联动刷新；分母为 0 的占比显示为 0.0%。
### 2025-11-09 操作记录：隐藏精友车型明细

- 操作位置：`开发文档/车险清单_2025年10-11月_合并-字段说明.md`
- 方法：在“厂牌车型名称”字段的“取值全集”行后插入 `<!-- ... -->` 注释开始标记，并在后续第一处字段标题“## 字段：车主证件号前六位”前插入注释结束标记，隐藏中间大段枚举列表。
- 注意：该方法为显示层隐藏，原始文本仍保留在文件中；如需彻底删除请通过脚本清洗并重新生成文档。
### 2025-11-09 字段与顺序核查

- 方法：用Python读取 CSV 表头与 `原始数据字段说明.md` 的 `## 字段：` 标题顺序，比较集合与顺序；检索 `docs/ARCHITECTURE.md` 是否存在正式映射表。
- 结论：MD包含的字段均在CSV中（集合一致），但MD缺少13列且顺序不一致；架构文档无逐列映射表。
- 动作：新增 `docs/FIELD_MAPPING.md`，作为正式映射表与派生口径说明。
### 修复日志（2025-11-09）

- 背景：GlobalFilterPanel 使用姓名键触发“业务员”筛选，后端数据列为“工号+姓名”。
- 变更：增强 `_apply_filters` 的“业务员”逻辑，兼容姓名与工号+姓名；新增测试 `test_staff_filter.py`。
- 结果：姓名筛选返回有效数据，测试通过。
- 影响：提升筛选一致性，避免姓名筛选导致空数据的体验问题。