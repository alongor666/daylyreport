# 开发文档索引

> 本目录用于记录每次开发前后阅读与更新的文档摘要与进展，确保团队协作一致性。

## 文档列表
- 问题记录表.md：记录待解决问题、数据异常与跟踪结果
- CLAUDE.md：开发规范与命令指引（镜像根目录的 CLAUDE.md 要点）
- PRD-best.md：精简版产品需求与关键约束（含筛选维度）
- PROGRESS.md：阶段进展与变更摘要

## 本次更新摘要（保单号唯一筛选约束）
- 新增前端“保单号”筛选维度，选择后自动联动“业务员、三级机构、团队”
- 后端 `_apply_filters` 支持保单号唯一过滤，并根据映射强制一致性
- 新增 `/api/policy-mapping` 接口，提供保单→业务员→机构/团队映射
- 仪表盘增加一致性校验提示：显示不一致保单计数
- 所有筛选一致性严格遵循 `业务员机构团队归属.json`

### 本次补充
- 前端组件已补充函数级中文注释（`FilterPanel.vue`、`Dashboard.vue`）。
- 设计指南（`docs/DESIGN_GUIDE.md`）新增“筛选面板规范（保单号唯一约束）”。
- 开发者指南（`docs/DEVELOPER_GUIDE.md`）新增 `/api/policy-mapping` 及一致性校验字段说明。
- 下一步：启动前后端并预览筛选面板UI，验证禁用态与提示文案。

### 图表展示改动（周对比趋势）
- 动态标签：在主值后紧跟“箭头 + 变化值 + 变化率”紧凑展示，不显示冗长文字与 D/D-7/D-14 标签。

## 本次更新摘要（占比类KPI上线） — 2025-11-09

- 新增四张占比类KPI卡片：
  - 电销保费占比（`valueType: 'percent'`，口径：保费）
  - 新能源件数占比（口径：件数）
  - 过户车件数占比（口径：件数）
  - 交强险保费占比（口径：保费）
- 后端 `get_kpi_windows` 返回 `ratios` 字段，包含上述占比；对分母为 0 与异常值做防护并裁剪至 `[0,1]`。
- 前端 `KpiCard.vue` 支持百分比格式显示（保留 1 位小数）；`Dashboard.vue` 完成卡片绑定与趋势逻辑一致接入。
- 数据口径一致性：所有前端请求统一传递 `data_scope`（与周对比接口一致），切换口径时占比数据同步变化。

### 验收与预览
- 预览仪表盘，四张占比卡随口径切换正确刷新；抽样核对分子匹配规则（电销/新能源/过户车/交强险）准确。
- 阈值与颜色：增长率 `> +5%` 用上升色、`< -5%` 用下降色，其余用中性色；箭头分别为 ↑ / ↓ / —。
- 悬停行为：按星期几索引同时显示三行（D-14、D-7、D）对应日期的数据；其中 D-14 行因无 D-21，对比部分显示为中性“—”。
- 图例（仅UI显示）：展示为“当周 / 上周 / 上上周”。内部语义仍严格使用 `D` / `D-7` / `D-14`，请勿在计算或数据结构中替换。
 - 布局与对齐：tooltip 每行采用 6 列网格（色点/日期/当期值/箭头/变化值/变化幅度）；当期值、变化值、变化幅度三列固定列宽并居中对齐，确保跨周视觉一致。

## 本次更新摘要（清亏业务占比） — 2025-11-09

- 指标定义：以字段 `车险新业务分类` 中取值为“清亏业务”的样本作为“分子”。
- 双口径支持：
  - 保费口径：`清亏保费 ÷ 总保费` → 返回 `ratios.loss_business.premium = { day, last7d, last30d }`
  - 件数口径：`清亏件数 ÷ 总件数` → 返回 `ratios.loss_business.count = { day, last7d, last30d }`
- 后端实现：`backend/data_processor.py` 新增 `_mask_loss_business` 与聚合计算，分母为 0 返回 0.0；比例裁剪至 `[0,1]`。函数均已添加中文注释（用途/入参/出参/边界）。
- 前端展示：`frontend/src/views/Dashboard.vue` 新增“KPI 卡：清亏业务占比”，随全局 `appStore.currentMetric` 在 `premium/count` 两口径间联动切换；格式为百分比保留 1 位小数。
- 验收与预览：在 Day/7D/30D 三窗口下，卡片的主值与迷你折线均能随口径切换刷新；分母为 0 显示 `0.0%`。

## 本次更新摘要（新增：商业险/异地车占比 + 异地车筛选） — 2025-11-09

- 新增两张占比类 KPI 卡：
  - 商业险占比：以保费为主口径（`ratios.commercial.premium`），显示商业险保费在总保费中的占比。
  - 异地车占比：同时提供保费与件数两口径（`ratios.non_local.premium/count`）。
- 后端 `backend/data_processor.py`：
  - 新增掩码函数 `_mask_commercial`、`_mask_non_local`，用于识别商业险与异地车；新增 `_ratio_premium/_ratio_count` 计算口径一致。
  - `get_kpi_windows` 扩展返回 `ratios.commercial` 与 `ratios.non_local`，结构与已有占比一致（包含 `day/last7d/last30d`）。
  - `get_filter_options` 新增“是否异地车”（值域：`全部/是/否`）；`_apply_filters` 支持按该项过滤。
- 前端：
  - `Dashboard.vue` 新增“商业险占比”“异地车占比”两张 KPI 卡，支持百分比显示与全局口径联动；已添加函数级中文注释。
  - `FilterPanel.vue` 新增“是否异地车”下拉筛选，选项由后端返回动态渲染。
- 字段来源：`开发文档/车险清单_2025年10-11月_合并-字段说明.md` 已包含“是否异地车”。
- 预览校验要点：
  - 切换“保费/客户数”时，两张新卡按对应口径刷新；分母为 0 时显示 0.0%。
  - 选择“是否异地车”为“是/否”，KPI 与明细联动变化；“全部”不影响筛选结果。

## 本次更新摘要（日期筛选/weekday/去重统一向量化） — 2025-11-09

- 日期筛选统一：
  - 将所有按天比较的写法（如 `df['投保确认时间'].dt.date == anchor.date()` 与区间比较）统一替换为基于 `Series.dt.normalize()` 的等值与区间掩码，避免 `date/NaT/时区` 混合导致的不稳定比较。
- 星期索引统一：
  - `get_week_trend/get_week_comparison` 等函数统一使用 `Series.dt.dayofweek`（周一=0）进行分组与对齐，替换 `datetime.weekday()` 与 `apply(lambda ...)` 的标量/逐元计算。
- 去重策略优化：
  - `get_policy_mapping` 与 `merge_with_existing` 的 `drop_duplicates(...)` 替换为 `duplicated(..., keep='first'|'last')` 掩码反选，稳健处理混合类型列；业务口径保持不变（映射保留首条、历史保留最新）。
- 验收与影响：
  - 周窗口（D/D-7/D-14）语义不变；占比与分布接口结构/值域不变；分母为 0 仍返回 0.0 并裁剪至 `[0,1]`。
  - 已在 `开发文档/PRD-best.md`/`CLAUDE.md`/`PROGRESS.md`/`问题记录表.md` 同步记录约束与验证说明。

## 检查清单
- 前端：筛选面板出现“保单号”下拉，并在选择后锁定机构/团队
- 后端：调用 `/api/policy-mapping` 返回非空映射
- 校验：存在不一致时在前端出现警告提示

## 本次更新摘要（筛选维度变更：业务员为主） — 2025-11-09

- 入口切换：筛选入口由“保单号”切换为“业务员”；保单号保留为后端数据关联与一致性校验用途，不直接作为 UI 入口。
- 联动与禁用：选择业务员后自动归一化其“团队/三级机构”，并禁用控件层面的手动修改，避免口径冲突；载荷统一携带归一化后的维度。
- 数据层支持：`stores/filter.js` 暴露 `resolveByStaff`，`applyFilter` 扩展联动归一化逻辑；相关函数均已补充函数级中文注释。
- 全局联动：`Dashboard.vue` 的全局指标切换（保费/客户数）联动四张占比类 KPI 卡，依据 `appStore.currentMetric` 在 `premium/count` 两口径间切换展示。

### 预览与验收（进行中）
- 启动后端 `http://localhost:5001` 与前端 `http://localhost:3000/`，检查：
  - 业务员选择后，“团队/三级机构”禁用态与归一化值正确；
  - 切换“保费/客户数”，占比类 KPI 主值与迷你折线随之联动刷新；
  - 请求载荷包含 `filters/data_scope/currentMetric`，后端返回 `ratios.*.premium/count` 结构完整。
  - 新增“清亏业务占比”卡随口径切换联动展示 `ratios.loss_business[premium|count]`，三窗口显示正常。

## 本次更新摘要（CSV 数据字典）

- 新增《车险清单_2025年10-11月_合并-字段说明.md》，包含每个字段的类型、格式与值域范围；文本类字段已穷举全部取值（含计数）。
- 脚本位置：`scripts/csv_field_profiler.py`，支持传参或默认分析根目录车险清单文件。
- 用途：辅助数据治理与前后端字段映射校验，作为PRD与开发规范的配套数据字典。

### 使用与验证
- 运行：`python3 scripts/csv_field_profiler.py` 或显式传参指定输入/输出路径。
- 生成位置：`开发文档/车险清单_2025年10-11月_合并-字段说明.md`。
- 验证点：
  - 日期列是否存在混合格式（含时间/不含时间），建议后续统一格式；
  - 数值/货币/百分比识别是否符合预期；
  - 文本列取值全集是否用于下游枚举校验与前端选项绑定。

### 隐私脱敏说明（字段明细屏蔽）
- 已对以下敏感字段隐藏“文本明细穷举”：被保险人、投保人、车牌号码/车牌号/号牌号码、车架号码/车架号/VIN、发动机号码/发动机号、批单号码/批单号、续保号码/续保单号。
- 当字段为“文本”类型时，文档将显示“隐私字段：已省略具体取值明细”，其余统计信息（类型/格式/长度范围/缺失率）仍保留。

### 隐私合规更新（敏感字段章节删除）
- 根据合规要求，现对上述敏感字段采取更严格策略：不再在数据字典中生成这些字段的章节（永久删除章节）。
- 已在 `scripts/csv_field_profiler.py` 中实现章节级跳过；生成文档路径与结构保持不变。
- 原始文档已备份：`开发文档/archive/车险清单_2025年10-11月_合并-字段说明-备份-2025-11-08.md`；变更详见《开发文档/数据字典变更记录.md》。
- 项目影响评估：仅影响文档内容，代码与接口无改动，运行与功能不受影响。
- 新增敏感字段：行驶证车主（含同义词：行驶证持有人/行驶证所有人），已在生成脚本中一并删除章节。
 - 细粒度策略：对“客户名称”保留章节与统计信息，但屏蔽文本取值明细（文档显示“隐私字段：已省略具体取值明细”）。

## 本次更新摘要（启动与测试）

- 后端：启动 `backend/api_server.py`，监听 `http://localhost:5001`，健康检查通过（`GET /api/health`）。
- 前端：运行 `npm run dev` 启动 Vite（端口 `3000`），预览地址 `http://localhost:3000/` 可访问。
- 联调：`vite.config.ts` 中 `/api` 代理到 `http://localhost:5001`，前端请求可达后端。
- 端口占用处理：如遇 5001 端口被占用，请先定位并结束占用进程（示例命令：`lsof -i :5001` + `kill <PID>`）。

### Bug修复摘要
- 修复根路径 404：访问 `http://127.0.0.1:5001/` 现在返回静态首页（或接口说明），通过为 Flask 显式配置 `static_folder` 指向项目根 `static/` 并新增 `/` 路由实现。

### 使用提醒
- 先启动后端，再启动前端以确保代理生效与接口联通。
- 预览加载成功后，按设计检查筛选面板禁用态与提示文案。

### 诊断修复记录（接口参数校验与冒烟） — 2025-11-08

- 接口：`POST /api/staff-performance-distribution` 增强入参校验。
  - `period`：必须为字符串，小写归一化后仅支持 `{day, last7d, last30d}`；
  - `filters`：必须为对象（JSON 字典）。
- 错误返回规范：非法 `period` 返回 400 并附带 `allowed` 列表；非法 `filters` 返回 400 并给出中文提示。
- 冒烟测试：
  - 非法 `period=week` → 400；
  - 合法 `period=day` 且 `filters={}` → 200，返回分布数据；
  - 非法 `filters="not-an-object"` → 400。
- 目的：减少未定义变量与类型不匹配问题，提升接口健壮性与可诊断性；相关函数级中文注释已补充到路由函数中。
---
诊断修复记录（2025-11-08 21:05）

修复概览
- 清除 KPI 卡片趋势类型告警：Dashboard 的 `calculateTrend` 返回数字类型并加注释。
- 端口与代理环境化：`vite.config.ts/js` 读取 `.env` 中的 `VITE_PORT` 与 `VITE_API_TARGET`，新增 `frontend/.env.example` 与默认 `frontend/.env.development`。
- 后端提示动态化：`api_server.py` 根路径 `preview` 与启动提示读取 `FRONTEND_URL/VITE_PORT`；API 端口读取 `API_PORT/PORT`。
- 前端数据请求错误日志增强：`stores/data.js` 在请求失败时输出状态码与响应体。

使用说明更新
- 调整端口：在 `frontend/.env.development` 设置 `VITE_PORT`；后端端口通过 `API_PORT` 或 `PORT` 设置。
- 调整代理：在 `.env` 设置 `VITE_API_TARGET` 指向后端地址。

验证
- 本地 `curl` 测试 `/api/week-comparison` 正常；UI 运行无 trend 类型告警。

---
诊断修复记录（2025-11-08 21:30）

问题复盘
- 前端控制台出现 `ReferenceError: payload is not defined`（源自 `stores/data.js` 在 `catch` 访问了 `try` 内变量）。
- 多个接口报 500，确认后端未启动是主要原因之一。

修复摘要
- 前端数据层：将 `payload` 提升为函数级作用域，保证错误日志可打印载荷；保留状态码与响应体输出；函数级中文注释说明修复目的。
- 后端：启动 Flask（`python3 backend/api_server.py`），端口支持 `API_PORT`/`PORT` 环境变量，提示信息已动态化。

验证
- `GET /api/filter-options` 返回选项；`POST /api/kpi-windows` 返回三口径数据。
- 前端不再出现 `payload 未定义` 与 500 错误。

操作建议
- 开发时同时启动前后端；端口/代理目标变更需同步 `.env` 并重启。
### 单位规范（2025-11-09）
- KPI 与周对比图对保费相关指标统一采用“万元整数”显示（保费、佣金、目标差距）；单量保持数字千分位显示。
- 实现位置：`ChartView.vue`（轴与 tooltip 格式化）、`KpiCard.vue`（新增 `valueType: 'wanInt'`）、`Dashboard.vue`（设置相关卡片为 `wanInt`）。
- 预览验证：`http://localhost:3001/` 加载正常，单位一致与箭头分栏布局已生效。

### 渠道判定规则更新（2025-11-09）
- 电销认定：当 `终端来源` 取值为 `0110融合销售` 时认定为“电销”，其余取值均为“非电销”。
- 适用范围：用于“电销占比”相关 KPI 的计算与展示；后端聚合建议输出布尔 `is_telesales` 与占比字段；前端新增/更新对应 KPI 卡片并沿用“万元整数”显示保费相关值。
- 口径说明：以 `终端来源` 为唯一认定口径；`业务来源`/`客户源` 中含“电销”字样仅用于核对，不参与口径认定，以避免口径歧义。

### KPI 卡扩展与口径说明（2025-11-09）
- 目标：新增四张占比类 KPI 卡，弱耦合接入筛选器与“数据口径”切换：
  - 电销占比（保费口径为主，可选单量口径）
  - 新能源占比（单量口径为主，可选保费口径）
  - 过户车占比（单量口径）
  - 交强险占比（保费口径）
- 原始字段：`终端来源`、`是否新能源`、`是否过户车`、`险种名称`、`签单/批改保费`、`签单数量`。
- 计算与健壮性：分母为0时返回0；结果裁剪到 `[0,1]`；统一百分比显示为 `XX.X%`。
- 前端改动：
  - `KpiCard.vue` 增加 `valueType: 'percent'` 支持百分比显示；不影响既有 `wanInt/number/currency`。
  - `Dashboard.vue` 的 `kpiCards` 追加四张卡；数据源读取 `dataStore.kpiData.ratios.*`。
- 后端改动：
  - `get_kpi_windows` 扩展返回 `ratios` 字段（保留原结构与键名稳定性）：
    - `ratios.telesales.premium` / `ratios.telesales.count`
    - `ratios.new_energy.count`
    - `ratios.transfer.count`
    - `ratios.mandatory.premium`
  - 继续应用 `data_scope` 与筛选器，保持与 `get_week_comparison` 一致的过滤路径。

## 本次更新摘要（置顶工具栏与全局指标切换） — 2025-11-09

- 工具栏置顶：将“数据筛选 + 数据口径 + 时间周期”整合为顶部置顶工具栏，随页面滚动固定。
- 全局切换：将“签单保费/签单单量”升级为全局切换并改名“保费/客户数”，位置在“数据口径”与“时间周期”之间。
- 筛选维度：将“保单号”改为“业务员”，控件置于“团队”之后；选择业务员时自动归一化其所属“团队/三级机构”。
- KPI：新增“保费达成率、保费缺口、商业险占比、新能源占比、过户车占比、异地车占比、电销占比”，占比类指标随“保费/客户数”联动。
- 年度计划：支持导入 `data/premium_plan.json`（或 CSV），命中维度组合显示“保费达成率/缺口”，未命中则隐藏两卡，不影响其他功能。

### 检查清单（置顶工具栏）
- 位置与命名：工具栏控件顺序为“数据口径｜保费/客户数｜时间周期”；筛选控件含“三级机构｜团队｜业务员”等。
- 联动一致性：选择业务员后自动归一化“团队/三级机构”，前后端映射一致；冲突由后端覆盖并返回提示。
- 载荷与口径：请求统一携带 `filters/data_scope/currentMetric`；占比字段包含 `premium/count` 两版本，前端据 `currentMetric` 取值。
- 计划导入：存在计划时显示“保费达成率/缺口”；无计划时 `plan_exists=false`，前端隐藏两卡。

### 需求理解与方案草图（置顶工具栏｜全局指标｜KPI）

- 布局草图：
  - 顶部固定工具栏：[数据口径] ｜ [保费/客户数] ｜ [时间周期] ｜ [筛选：三级机构｜团队｜业务员]
  - 主区：KPI 卡组（含占比类、达成率/缺口）；周对比图（消费全局指标）

- 全局状态：
  - `appStore.currentMetric`：'premium' | 'count'
  - `appStore.dataScope`：'daily' | 'weekly' | 'monthly'
  - `filterStore.filters`：{ salesperson, team, org3, is_renewal, ... }

- 数据流：
  - 工具栏交互 → 更新 `appStore`/`filterStore` → 统一触发 `dataStore` 请求 → KPI/图表组件响应。
  - ChartView 不维护本地指标切换，仅监听 `appStore.currentMetric`。

- 载荷示例：
```json
{
  "metric": "premium",
  "filters": {"salesperson":"张三","team":"A1","org3":"分部X"},
  "data_scope": "weekly",
  "date_range": ["2025-11-01","2025-11-09"]
}
```

- 边界与告警：
  - 维度冲突/缺失：后端返回 `ambiguity/missing_dimension`，前端以 Banner 告警并按配置剔除样本。
  - 分母为 0：占比返回 0.0，裁剪至 `[0,1]`。

- 验收要点：
  - 切换“保费/客户数”全局联动所有图表与 KPI。
  - 选择“业务员”自动归一化其团队/三级机构；载荷与后端映射一致。
## 全局看板升级摘要（2025-11-09）

本次升级统一了监控指标的双口径（件数/保费）与关键识别规则：
- 所有监控占比均支持 `count` 与 `premium` 切换与计算。
- 单交占比：以“险别组合=单交”为识别来源；必要时回退到“仅交强险，不含商险”。
- 新保占比：来自字段 `是否续保=新保` 的值域。
- 核心KPI采用年度目标 43100 的分解：日=43100/354，7天=43100/50，30天=43100/12；达成率与目标缺口遵循颜色规则（正红、负绿、零灰）。

验收提示：切换到保费口径时占比应与件数口径不同但合理；分母为 0 的情况显示为 0%，不抛异常。
### 更正说明（2025-11-09 晚）
- 监控指标默认展示保费口径（`premium`），切换到件数（`count`）无需确认；切换需具备明显视觉效果。
- `是否续保` 值域为 `新保/转保/续保`，新保占比仅以 `新保` 为分子。
- 单交占比仅以“险别组合=单交”为准，不再设置回退规则。
- 筛选视觉规范统一：字体大小、颜色与状态一致，避免不同筛选项出现风格漂移。

## 本次更新摘要（监控双口径补齐 + 新保/单交 + 标签更名“件数”） — 2025-11-09 夜

- 后端：`get_kpi_windows` 补齐所有监控占比的双口径返回（`premium/count`），并新增两类占比：
  - `single_mandatory_ratio`（单交占比）：识别“险别组合=单交”，支持保费/件数双口径；
  - `new_policy_ratio`（新保占比）：识别 `是否续保=新保`，支持保费/件数双口径；
  - 同步为 `new_energy/transfer/commercial/mandatory` 全量提供 `premium` 与 `count` 两版本。
- 前端：
  - 仪表盘替换“交强占比”为“单交占比”，并新增“新保占比”卡片；数据源读取 `kpiData.ratios.single_mandatory/new_policy`；
  - 全局指标切换的“客户数”标签更名为“件数”，并统一样式（默认/悬停/选中）与过滤控件一致；
  - 口径切换高亮与状态反馈已实现（`metric-toggle__button--active`）。
- 预览与验收：
  - 预览地址：`http://localhost:3010/`；后端使用既有 `http://localhost:5001`；
  - 切换“保费/件数”时，监控占比卡随口径正确刷新；分母为 0 时显示 `0.0%`；
  - 新保/单交占比识别规则准确，返回结构包含 `day/last7d/last30d` 三窗口与双口径键。

### 注意事项（文档与规范）
- UI 文案统一：在所有位置使用“保费/件数”而非“保费/客户数”；
- 代码注释：新增/修改函数均补充函数级中文注释，说明用途与边界；
- 契约稳定：`ratios.*` 字段结构保持不破坏，扩展仅新增键与口径版本。

## 仪表盘分区与标题规范（核心KPI/监控占比/计划达成） — 2025-11-09

- 分区与标题：
  - 核心KPI（标题：核心KPI）：仅展示三张卡片“签单保费/签单单量/签单佣金”。
  - 监控占比（标题：监控占比）：展示电销/商业险/新能源/过户车/异地车/单交/新保/清亏业务占比等监控类KPI。
  - 计划达成（标题：计划达成）：展示“目标差距”；若后端返回 `plan_exists=true`，追加“保费达成率/保费缺口”。
- 契约与绑定：
  - 占比类指标统一消费 `kpiData.ratios.*[currentMetric]`，支持 `premium/count` 双口径与 `day/last7d/last30d` 三窗口。
  - 计划类指标消费 `premium_progress/premium_gap/plan_exists`（命中时返回）；`目标差距`在未接入计划时回退使用 `target_gap_day`。
- 验收要点：
  - 三个分区均有中文标题且布局分明；核心KPI仅三张卡，监控占比与计划达成的卡片在各自分区展示。
  - 切换“保费/件数”时监控占比卡正确刷新；命中计划时显示达成率/缺口，未命中则仅展示目标差距。
## 文档维护说明（2025-11-09）

- 为控制字段说明文档体积与提升可读性，已将“厂牌车型名称”字段的精友车型取值明细隐藏（通过 HTML 注释）。
- 隐藏范围：自“取值全集（共 6495 项，含计数）”起，至“## 字段：车主证件号前六位”前。
- 若需查看完整明细，请使用归档文件或通过脚本生成专用清单。
## 业务员筛选格式兼容说明（2025-11-09）

- 前端可能传入两种“业务员”筛选值：
  - 仅中文姓名（来自 policy-mapping 的 `staff_to_info` 键）；
  - 工号+姓名（来自 filter-options 的 `业务员` 列表）。
- 后端处理策略：
  - 自动识别传入值是否含数字；
  - 含数字时按“工号+姓名”等值过滤；
  - 不含数字时按中文姓名进行映射反查或回退匹配，确保筛选生效。
- 相关代码：`backend/data_processor.py::_apply_filters`。