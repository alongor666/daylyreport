# PRD-best（精简版需求说明）

## 目标
- 前端筛选维度中，以“保单号”作为唯一标识。
- 保单号对应“业务员”，业务员对应“团队简称/三级机构”，严格遵循 `业务员机构团队归属.json`。

## 约束
- （历史约束）当用户选择“保单号”时：自动联动并锁定“业务员/三级机构/团队”值，以映射为准。
- （更新）筛选入口切换为“业务员”，保单号用于后端关联与一致性校验，不直接暴露为 UI 入口；选择业务员时前端自动归一化其团队/三级机构并禁用手动修改。
- 若用户选择的机构/团队与映射不一致：后端覆盖为映射值；映射缺失或冲突时，前端显示警告并在问题记录表登记。

> 设计关联：详见 `docs/DESIGN_GUIDE.md` 的“筛选面板规范（保单号唯一约束）”，其中明确联动、禁用与提示规则。

## API
- `GET /api/policy-mapping`：返回保单→业务员与业务员→机构/团队映射。
- `GET /api/filter-options`：返回筛选选项（含“保单号”列表）。
- `POST /api/kpi-windows`、`POST /api/week-comparison`：应用筛选并返回 `validation`（含 `policy_consistency`）。

## 前端交互
- 交互入口更新：以“业务员”为主筛选入口；选择后禁用“三级机构/团队”手动输入，显示归一化值，防止不一致。
- 应用筛选时自动补充“业务员/团队/三级机构”归一化字段，保证后端过滤一致性。
- 仪表盘显示“数据映射警告”：未匹配业务员数与不一致保单数。

## 图表展示（周对比趋势）
- 动态标签（Tooltip）：在主值后紧跟“箭头 + 变化值 + 变化率”的紧凑展示；不展示 D/D-7/D-14 标签与周期汇总值，也不使用冗长状态文案。
  - 箭头：↑（上升）、↓（下降）、—（持平/无对比）。
  - 颜色阈值：增长率 `> +5%` 使用上升色；`< -5%` 使用下降色；其余使用中性色。
  - 布局：每行采用 6 列网格（色点/日期/当期值/箭头/变化值/变化幅度），数值列固定宽度并居中对齐，以保证不同周的数据严格对齐与快速理解。
 - 图例（Legend，仅UI显示）：以中文标签展示“当周 / 上周 / 上上周”。注意：内部数据与计算仍以 `D` / `D-7` / `D-14` 为唯一语义来源，禁止在逻辑中替换。
 - 悬停行为：在21天窗口内，鼠标悬停某星期几时，动态标签同时展示三条数据行（上上周 D-14、上周 D-7、当周 D），每行包含“日期、主值与箭头紧凑变化信息”；其中 D-14 因无 D-21，对比部分显示为中性“—”。

## 验收标准
- 选择任意保单号，数据展示与对应业务员/机构/团队一致。
- 映射不一致的保单能被检测并计数提示。
- 映射文件更新后，前端重新加载选项与映射，行为一致。
 - 筛选面板禁用态与提示文案符合设计指南规范。
 - 周对比趋势的动态标签与图例符合上述展示规范；其中图例中文标签仅为UI显示，不改变内部语义。
 - 数据字典（CSV字段说明）已生成并归档：`开发文档/车险清单_2025年10-11月_合并-字段说明.md`，字段类型/格式/值域明确，用于规则校验与前端枚举绑定。
 - 隐私合规：数据字典中对被保险人、投保人、车牌号码/车牌号/号牌号码、车架号码/车架号/VIN、发动机号码/发动机号、批单号、续保单号隐藏“文本明细穷举”，仅保留统计信息。
 - 隐私合规更新：上述敏感字段的章节不生成（永久删除），文档不包含其条目。
 - 新增敏感字段：行驶证车主（含同义词：行驶证持有人/行驶证所有人），文档不生成对应条目。
 - 细粒度隐私：对“客户名称”保留章节与统计信息，但屏蔽文本明细，文档应显示隐私提示语。

### 启动与测试（补充验收）
- 可启动性：后端 API 启动并通过健康检查（`GET /api/health`）；前端开发服务器可访问 `http://localhost:3000/`。
- 联调可用：前端通过 `/api` 代理访问后端 `http://localhost:5001`，基本页面与接口加载成功。
 - 根路径行为：访问 `http://127.0.0.1:5001/` 返回静态首页（或接口说明），不存在 404。

## 占比类KPI（已实施） — 2025-11-09

### 指标定义与口径
- 电销保费占比：分子为电销保费（`终端来源=0110融合销售`），分母为总保费。
- 新能源件数占比：分子为新能源件数（新能源标志字段），分母为总件数。
- 过户车件数占比：分子为过户车件数（过户标志字段），分母为总件数。
- 交强险保费占比：分子为交强险保费（`险种名称=0301`），分母为总保费。
- 商业险保费占比：分子为商业险保费（默认识别 `0312/0313/0317` 或名称含“商业”），分母为总保费。
- 异地车占比：
  - 保费占比：分子为异地车保费（`是否异地车=是`），分母为总保费。
  - 件数占比：分子为异地车件数（`是否异地车=是`），分母为总件数。

### 清亏业务占比（新增）
- 业务口径：以字段 `车险新业务分类` 的取值为“清亏业务”作为分子样本集合。
- 双口径定义：
  - 保费占比：`清亏保费 ÷ 全保费` → 返回 `ratios.loss_business.premium = { day, last7d, last30d }`
  - 件数占比：`清亏件数 ÷ 全件数` → 返回 `ratios.loss_business.count = { day, last7d, last30d }`
- 边界与健壮性：分母为 0 返回 0.0；比例裁剪至 `[0,1]`；数值在前端统一以百分比（保留 1 位小数）显示。
- 前端展示：Dashboard 新增“KPI 卡：清亏业务占比”，随全局“保费/客户数”切换联动；趋势与迷你折线与既有卡一致。

### 展示与格式
- 前端以 KPI 卡片形式展示，`valueType: 'percent'`，保留 1 位小数并显示百分号。
- 支持三窗口：当日、近7天、近30天；趋势与迷你折线与既有KPI一致。

### 口径与一致性
- 数据口径 `data_scope` 统一由前端在所有请求载荷中传递，与周对比接口一致；支持 `'exclude_correction'` 等预设。
- 切换数据口径时，四张占比卡同步刷新，确保统计口径一致。
 - 新增两张卡（商业险/异地车）随全局“保费/客户数”切换联动，分别消费 `ratios.commercial.premium` 与 `ratios.non_local.premium/count`。

### 校验与验收
- 分母为 0 时返回 0.0；比例裁剪至 `[0,1]`；异常值防护完备。
- 抽样核对分子匹配规则；与原始样本一致后通过验收。

## 筛选项更新（已实施）
- 新增筛选项“是否异地车”（值域：`全部/是/否`）。
- 后端：`get_filter_options` 返回该项；`_apply_filters` 应用筛选逻辑。
- 前端：`FilterPanel.vue` 动态渲染该下拉选项；与其他布尔型选项（如“是否电销/是否过户车/是否新能源”）保持一致模式。

## 诊断修复记录（后端入参校验与错误处理） — 2025-11-08

- 路由 `POST /api/staff-performance-distribution` 增强入参校验：
  - `period` 必须为字符串，归一化为小写后需属于 `{day, last7d, last30d}`；
  - `filters` 必须为对象（JSON 字典）。
- 错误返回规范：非法 `period` 返回 400 并附带 `allowed` 列表；非法 `filters` 返回 400 并提供中文提示。
- 冒烟验证：
  - `period=week` → HTTP 400，JSON 中包含 `message` 与 `allowed`；
  - `period=day` + `filters={}` → HTTP 200，返回分布数据结构；
  - `filters="not-an-object"` → HTTP 400，返回中文提示。
- 目的：减少未定义变量与类型不匹配问题，提升接口健壮性与可诊断性。
---
诊断修复记录（2025-11-08 21:05）

背景与问题
- KPI 卡片的趋势 `trend` Props 类型为 `Number`，但前端计算返回 `String` 导致 Vue 警告。
- 前后端端口与代理硬编码影响开发体验与环境切换。

修复与规范化
- 前端：Dashboard `calculateTrend` 统一返回数字；Vite 端口与 API 代理改为 `.env` 参数化（`VITE_PORT`、`VITE_API_TARGET`）。
- 后端：启动提示与根路径 `preview` 动态读取 `FRONTEND_URL` 或 `VITE_PORT`；API 端口读取 `API_PORT/PORT`。
- 前端数据层增强错误日志，明确 400 入参错误等场景。

效果与验证
- 类型告警消除；周对比接口本地验证成功；端口提示统一为 `.env` 配置。

后续建议
- 统一将环境变量写入 CI/CD 与部署说明，减少环境差异。

---
诊断修复记录（2025-11-08 21:30）

背景与问题
- 仪表盘加载过程中出现 `ReferenceError: payload is not defined`，导致 KPI 与图表请求失败；同时前端多个接口报 500。

修复与规范化
- 前端数据层：提升 `payload` 至函数级作用域，保证在错误日志中可打印请求载荷；保留状态码与响应体输出，便于定位问题。
- 后端服务：确认 Flask 未启动导致 500；启动后端（`python3 backend/api_server.py`）并使用环境变量控制端口（`API_PORT`/`PORT`）。

效果与验证
- `GET /api/filter-options` 正常返回；`POST /api/kpi-windows` 正常返回三口径数据。
- 前端不再出现 `payload 未定义` 与 500 报错。

建议
- 开发流程中明确要求同时启动前后端；端口/代理目标变更需同步 `.env` 并重启服务。

### 单位规范（2025-11-09）
- 保费相关指标（保费、佣金、目标差距）在 KPI 与周对比图中统一以“万元整数”显示；单量保持数字千分位显示。
- 目的：降低单位切换带来的认知成本，提升跨组件的一致性与可读性。

## 渠道判定规则（2025-11-09 新增）

- 电销判定口径：当字段 `终端来源` 的取值为 `0110融合销售` 时，认定为“电销”；其余取值（如 `0101柜面`、`0106移动展业(App)`、`0107B2B`、`0112AI出单`、`0201PC`、`0202APP`）均认定为“非电销”。
- 使用范围：用于“电销占比”KPI 的分子（电销保费/保单数）与分母（全渠道保费/保单数）。
- 交叉字段说明：数据中还存在 `业务来源`（如 `1900102直接业务（电销）`）与 `客户源`（部分带有“（电销）”标注）；为保持一致性，本项目以 `终端来源` 的判定为唯一口径，其他字段仅用于数据核对，不参与口径认定。
- 计算口径建议：
  - 保费口径（默认）：`电销保费 ÷ 全渠道保费`，保费以“签单/批改保费”为主，必要时使用“签单保费/承保保费”兜底。
  - 保单数口径（备选）：`电销保单数 ÷ 全渠道保单数`，按保单号聚合去重后计算。
- 退保/批改处理：如需剔除退保，请结合 `批改类型=16退保` 过滤；否则采用净额口径统计。

实施建议（后端/前端）
- 后端：在聚合层新增布尔字段 `is_telesales = (终端来源 === '0110融合销售')`，并将渠道维度聚合支持该字段；返回 `telesales_premium_ratio` 与 `telesales_policy_ratio`。
- 前端：新增“电销占比”KPI 卡片，数据源采用后端返回；与其他卡片保持单位与格式一致。

验证点
- 随机抽样记录核对：`终端来源=0110融合销售` 的记录应全部计入电销分子；其他取值不计入。
- 与 `业务来源=1900102直接业务（电销）` 的统计进行对比，允许差异但不影响口径认定。

## KPI 卡扩展（2025-11-09 新增）

目标
- 新增四张占比类 KPI 卡：电销占比、新能源占比、过户车占比、交强险占比；与现有筛选器和“数据口径”切换弱耦合集成。

字段与口径
- 原始字段：`终端来源`、`是否新能源`、`是否过户车`、`险种名称`、`签单/批改保费`、`签单数量`。
- 电销占比：保费占比为主（`电销保费 ÷ 全保费`），可选显示单量占比。
- 新能源占比：单量占比为主（`新能源件数 ÷ 全件数`），可选显示保费占比。
- 过户车占比：单量占比（`过户车件数 ÷ 全件数`）。
- 交强险占比：保费占比（`险种名称=0301 的保费 ÷ 全保费`）。
- 边界与健壮性：分母为0返回0；结果裁剪至 `[0,1]`；统一显示为百分比 `XX.X%`。

后端返回结构（建议）
- 在 `POST /api/kpi-windows` 返回体中新增 `ratios` 字段（不影响既有结构）：
  - `ratios.telesales.premium` / `ratios.telesales.count`
  - `ratios.new_energy.count`
  - `ratios.transfer.count`
  - `ratios.mandatory.premium`
- 必须应用 `data_scope` 与 `filters`，与 `POST /api/week-comparison` 的过滤一致。

前端展示与格式
- `KpiCard.vue` 支持 `valueType: 'percent'` 格式化为 `XX.X%`；保留 `wanInt/number/currency`。
- `Dashboard.vue` 的 `kpiCards` 追加四张卡片，数据源读取 `dataStore.kpiData.ratios.*`；既有卡片不改动。

验收
- 抽样核对：
  - 电销分子：`终端来源=0110融合销售` 
  - 交强分子：`险种名称=0301`
  - 新能源/过户分子：分别来自 `是否新能源=是`、`是否过户车=是`
- 切换“数据口径”和筛选器时，四张新卡的占比值随之刷新，且不影响既有功能与展示。

## 新需求（2025-11-09：置顶工具栏与全局指标切换）

### 概览
- 将“签单保费/签单单量”切换提升为全局切换，改名为“保费/客户数”，位置在“数据口径”与“时间周期”之间。
- 筛选维度由“保单号”改为“业务员”，并在工具栏中置于“团队”之后；选择业务员时自动归一化其所属“团队/三级机构”。
- 将“数据筛选 + 数据口径 + 时间周期”整合为顶部置顶工具栏（Sticky Toolbar），随页面滚动固定于顶端。
- KPI 优化：新增“保费达成率、保费缺口、商业险占比、新能源占比、过户车占比、异地车占比、电销占比”，占比指标随全局“保费/客户数”切换联动。

### 原始字段与口径（数据侧不变）
- 主度量：`签单/批改保费`、`签单数量`。
- 电销判定：`终端来源=0110融合销售`。
- 标志字段：`是否新能源`、`是否过户车`、`是否异地车`（是/否）。
- 商业险识别：`险种名称` 属于商险集合（建议配置 `config/insurance_map.json`，默认包含 `0312/0313/0317`）。
- 组织维度：`业务员`、`团队简称`、`三级机构`（源自 `业务员机构团队归属.json`）。

### 年度保费计划（达成率/缺口）
- 计划文件：`data/premium_plan.json`（或 CSV），字段：`year/三级机构/团队简称/业务员/业务类型/plan_amount`。
- 匹配策略：逐级匹配（业务员>团队>三级机构>业务类型），命中后返回：
  - `premium_progress = 实际保费 ÷ 计划保费`
  - `premium_gap = 计划保费 - 实际保费`
  - `plan_exists = true`
  未命中则 `plan_exists=false`，前端隐藏“保费达成率/缺口”。

### 接口与数据一致性
- 前端载荷：所有请求携带 `filters` 与 `data_scope`，并读取全局 `currentMetric`（`'premium'|'count'`）。
- 后端返回：
  - `ratios.*.premium/count` 同时提供保费/客户数口径的数据；前端依据 `currentMetric` 选择展示。
  - 计划相关键（`premium_progress/premium_gap/plan_exists`）仅在命中计划时返回。

### 验收标准
- 工具栏置顶，控件位置与标签符合规范（“保费/客户数”位于“数据口径”与“时间周期”之间）。
- 切换“保费/客户数”后，KPI 与趋势图随之联动；占比类 KPI 随口径切换展示保费或客户数版本。
- 选择“业务员”后自动归一化“团队/三级机构”，与映射保持一致；不一致时后端覆盖并返回校验提示。
- 导入年度计划后，命中维度组合显示“保费达成率/缺口”；未命中则隐藏两卡，不影响其他功能。
### 更新补充（2025-11-09：筛选维度变更）
- 入口：以“业务员”为主；保单号不作为 UI 入口，仅用于后端关联与校验。
- 联动：业务员选择后，前端禁用“团队/三级机构”的手动修改，并显示归一化值；后端仍作为最终裁决来源。
- 接口不变：保留 `/api/policy-mapping`、`/api/filter-options`、`/api/kpi-windows` 等；返回中继续包含 `validation.policy_consistency` 字段用于一致性提示。
## 全局看板升级（核心KPI与监控指标）- 规格确认 2025-11-09

为保证一致性与可验收性，本节明确核心KPI与监控指标的展示、口径与交互。

### 核心KPI（固定保费口径）
- 签单保费：当前周期的保费累计（Day/7D/30D）。
- 达成率：实际保费 / 目标保费（目标分解见 ARCHITECTURE.md 15.1）。
- 目标缺口：实际保费 - 目标保费；为正显示红色，为负显示绿色，为 0 显示中性灰。

### 监控指标（全部支持件数/保费双口径）
- 商险占比（commercial_ratio）：支持 `count` 与 `premium` 切换。
- 新能源占比（new_energy_ratio）：支持 `count` 与 `premium` 切换。
- 过户车占比（transfer_ratio）：支持 `count` 与 `premium` 切换。
- 融合销售占比（telesales_ratio）：支持 `count` 与 `premium` 切换。
- 异地车占比（non_local_ratio）：支持 `count` 与 `premium` 切换。
- 单交占比（single_mandatory_ratio）：识别“险别组合=单交”，支持 `count` 与 `premium` 切换。
- 新保占比（new_policy_ratio）：字段 `是否续保=新保`，支持 `count` 与 `premium` 切换。

### 交互与展示
- 默认口径：监控指标默认以 `count` 展示，提供显式切换到 `premium`。
- 时间维度：所有卡片支持 Day / Last7d / Last30d 三档。
- 边界与兜底：分母为 0 的占比显示 `0%`；数据缺失不抛异常。

### 验收清单（UAT）
- 切换口径时占比随之正确变化，且契约完整（各比值均存在）。
- 新保占比取值来自 `是否续保=新保`；单交占比取值来自“险别组合=单交”。
- 核心KPI按目标分解计算达成率与缺口，颜色规则正确。
### 规格更正（2025-11-09 晚）
- 值域：`是否续保` 为 `新保/转保/续保`；新保占比仅取 `新保`。
- 单交：仅使用“险别组合=单交”，不设回退规则。
- 默认口径：监控指标默认展示 `保费`，可显式切换到 `件数`；切换无需确认，但需明显视觉效果（选中高亮/颜色变化/过渡）。
- 筛选视觉：统一字体大小、颜色与状态（默认/悬停/选中/禁用），并在前端以样式变量统一管理。

### 监控指标扩展（2025-11-09 晚）— 单交/新保占比（已实施）
- 新增 KPI：
  - 单交占比（`single_mandatory_ratio`）：识别“险别组合=单交”；支持 `premium/count` 双口径；显示 `day/last7d/last30d` 三窗口。
  - 新保占比（`new_policy_ratio`）：识别 `是否续保=新保`；支持 `premium/count` 双口径；显示 `day/last7d/last30d` 三窗口。
- 前端绑定：Dashboard 新增/替换相应卡片，数据源为 `kpiData.ratios.single_mandatory/new_policy`，随 `appStore.currentMetric` 联动；默认以 `premium` 显示。
- 验收：切换“保费/件数”时两卡正确刷新；分母为 0 显示 `0.0%`；视觉状态与筛选控件一致。

## 仪表盘分区与标题（规格补充）— 2025-11-09 晚

### 分区定义
- 核心KPI（标题：核心KPI）：固定三项 — 签单保费、签单单量、签单佣金。
- 监控占比（标题：监控占比）：包含电销/商业险/新能源/过户车/异地车/单交/新保/清亏业务占比，均支持 `premium/count` 双口径。
- 计划达成（标题：计划达成）：默认显示“目标差距”；当 `plan_exists=true` 时追加“保费达成率/保费缺口”。

### 契约与交互
- 全局切换：分区与卡片仅消费全局 `currentMetric` 与 `currentPeriod`；前端不维护分区内的局部切换。
- 计划契约：`premium_progress/premium_gap/plan_exists` 命中后返回；未命中时仅展示 `target_gap_day` 对应的目标差距。
- 视觉规范：分区标题使用 `kpi-section-header__title`；三分区之间保持等距与统一网格 `dashboard__kpi-grid`。

### 验收
- 页面存在三处分区标题（中文）：“核心KPI”“监控占比”“计划达成”。
- 核心KPI仅三张卡；监控占比包含约定清单；计划达成命中计划时显示达成率/缺口，未命中不显示占位。