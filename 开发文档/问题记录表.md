# 问题记录表

> 用于记录与跟踪本次迭代中的问题与处理状态。

## 当前问题

- 保单号映射冲突：`get_policy_mapping.conflicts` 列表中的姓名存在多条信息
  - 影响：可能导致团队或机构联动不明确
  - 处理：前端提示冲突，后端以映射文件为准，待数据治理

- 数据中的“团队/三级机构”字段与映射不一致
  - 影响：统计口径不一致
  - 处理：后端 `_validate_policy_consistency` 检测并返回 `mismatch_policies`，前端提示

- 部分业务员在数据中存在但映射文件缺失
  - 影响：无法进行机构/团队筛选
  - 处理：`_validate_staff_mapping` 返回 `unmatched_staff`，要求补齐映射

- 字段格式不一致与规范化问题（来源：CSV数据字典）
  - 保单号被识别为“货币”类型（混入单位/符号），建议后续规范为纯文本或纯数字（不含单位符号）以避免解析歧义。
  - 日期类字段同时存在“含时间”与“仅日期”两种格式，建议统一为一种格式（推荐含时间）。
  - 续保单号缺失率较高：约 58.36%，需明确业务口径与补齐策略或在下游逻辑中容错处理。

- 渠道判定规则口径新增与影响（2025-11-09）
  - 新增认定：`终端来源=0110融合销售` 视为“电销”，其他视为“非电销”。
  - 影响面：电销相关 KPI（占比/保费/单量）的统计与展示；保费沿用“万元整数”显示。
  - 风险/歧义：`业务来源/客户源` 中含“(电销)”字样的记录不参与认定，可能与终端来源存在差异；需在数据治理中注明解释。
  - 待确认：批改负值对电销保费是否参与占比分母；电销单量对批改类型的处理口径（含退保/批改）。

- 口径风险与待确认项（四个新KPI卡） — 2025-11-09
  - 新能源占比：主口径采用“单量占比”，是否需要保费占比作为辅助显示？若启用保费占比，负值保费是否纳入分母。
  - 过户车占比：分子来自 `是否过户车=是` 的件数；是否存在“过户且退保/批改负值”的样本需要剔除？
  - 交强险占比：分子限定 `险种名称=0301`；若同保单含多险种，分母是否按整单保费或按交强保费分母？当前设计为整单保费分母。
  - 电销占比：以电销保费为主；是否同时展示电销单量作为次指标？若展示，是否受批改类型影响（退保计件处理）。

- 业务员筛选联动与控件禁用（2025-11-09 新增）
  - 背景：筛选入口从“保单号”切换为“业务员”，需确保联动与禁用逻辑一致。
  - 影响：若用户尝试手动修改“团队/三级机构”，需在 UI 层禁用并显示归一化值；后端仍以映射文件为裁决来源。
  - 处理：`FilterPanel.vue` 已实现联动与禁用；`stores/filter.js` 暴露 `resolveByStaff` 并在 `applyFilter` 中统一归一化；问题项同步记录至此，待数据治理消除冲突。

## 已解决/进展

- 前端加入“保单号”筛选并联动业务员/团队/机构，锁定一致性
- 后端新增 `/api/policy-mapping` 接口，提供映射源
- 后端过滤逻辑强制依映射一致性覆盖前端冲突值
- 文档补齐：设计指南新增筛选面板规范；开发者指南补充端点与校验字段
- 图表展示规范实现：动态标签与图例显示已按 PRD-best 要求更新
  - 图例中文标签仅为 UI 显示，内部仍以 `D`/`D-7`/`D-14` 作为唯一语义来源（防误用）
  - 动态标签悬停显示三行：D-14/D-7/D，对应日期与较7天变化（D-14 无对比）
  - 动态标签布局优化：采用 5 列网格（色点/日期/当期值/变化/变化幅度），三数值列固定宽度与居中对齐，提升可读性
  - 数据字典隐私脱敏：对被保险人、投保人、车牌号码/车牌号/号牌号码、车架号码/车架号/VIN、发动机号码/发动机号、批单号、续保单号屏蔽“文本明细”，保留统计信息，满足合规要求。
  - 隐私合规更新：永久删除上述敏感字段的章节；原始文档已备份至 `开发文档/archive/车险清单_2025年10-11月_合并-字段说明-备份-2025-11-08.md`，确认对项目功能无负面影响。
  - 新增敏感字段处理：行驶证车主（含同义词：行驶证持有人/行驶证所有人）章节已删除，合规记录已更新。
  - 细粒度隐私策略：客户名称章节保留，但文本明细屏蔽，已验证文档显示隐私提示语。

- 启动与冒烟：后端 `http://localhost:5001` 健康检查通过；前端 `http://localhost:3000/` 预览加载正常；Vite `/api` 代理可用。
 - Bug修复：修复后端根路径 `http://127.0.0.1:5001/` 返回 404 的问题；新增根路径返回静态首页（或接口说明），并配置静态目录。

## 待办

- 数据团队确认 `业务员机构团队归属.json` 中冲突姓名的唯一归属
- 完善映射文件数据质量校验（重复、空值、格式）
- 启动并预览前端筛选面板，验证禁用态与一致性提示
  - 针对数据字典暴露问题制定治理计划：统一日期格式；明确保单号字段类型；评估高缺失字段的业务影响与处理策略。

- 回归测试（2025-11-09 新增）
  - 用例：选择不同业务员时，验证“团队/三级机构”禁用态与归一化值正确；切换“保费/客户数”后，占比类 KPI 主值与趋势联动刷新。
  - 结果登记：通过/失败与问题详情，请在本表追加记录。

## 已实施更新 — 2025-11-09（占比类KPI上线）

- 新增四张占比类KPI卡片并通过验收：
  - 电销保费占比（分子：`终端来源=0110融合销售`；口径：保费）
  - 新能源件数占比（分子：新能源标志字段；口径：件数）
  - 过户车件数占比（分子：过户标志字段；口径：件数）
  - 交强险保费占比（分子：`险种名称=0301`；口径：保费）
- 后端 `get_kpi_windows` 返回 `ratios` 字段；分母为 0 返回 0.0 并裁剪比例至 `[0,1]`；已加中文注释。
- 前端 `KpiCard.vue` 支持 `valueType: 'percent'`；`Dashboard.vue` 完成卡片绑定；`stores/data.js` 所有请求载荷统一传递 `data_scope`。
- 冒烟与抽样：随数据口径切换占比值同步变化；抽样核对分子规则准确，无异常值。
- 渠道规则验证：抽样 `终端来源=0110融合销售` 的记录核对 `is_telesales` 映射与占比计算；与 `业务来源/客户源` 含“电销”字样进行差异比对。

## 已实施更新 — 2025-11-09（商业险/异地车占比 + 异地车筛选）

- 新增两张 KPI 卡：商业险占比、异地车占比；两卡随全局“保费/客户数”切换联动，显示为百分比。
- 后端：`data_processor.py` 新增 `_mask_commercial/_mask_non_local` 与 `ratios.commercial/non_local`；`get_filter_options` 返回“是否异地车”，`_apply_filters` 应用该项过滤；相关函数已补充中文注释。
- 前端：`Dashboard.vue` 新增两卡并绑定 `kpiData.ratios.*[currentMetric]`；`FilterPanel.vue` 新增“是否异地车”下拉，选项由后端返回。
- 验收要点：
  - 切换“保费/客户数”，两卡按口径正确刷新；分母为 0 时显示 0.0%。
  - 切换“是否异地车”为“是/否”，KPI 与明细联动变化；“全部”不影响结果。
- 备注：数据字典已包含“是否异地车”字段；如后续需要“未知”三态显示，将在前端增加枚举并调整统计口径（当前为二态+全部）。

## 诊断修复记录 — 2025-11-08

- 后端接口参数校验增强（`POST /api/staff-performance-distribution`）：
  - `period` 必须为字符串，归一化为小写后需属于白名单 `{day, last7d, last30d}`；
  - `filters` 必须为对象（JSON 字典）。
- 错误返回方式：当 `period` 非法时返回 400，并在 JSON 中附带 `allowed` 列表；当 `filters` 类型错误时返回 400 并给出中文提示。
- 冒烟验证结果：
  - `period=week` → HTTP 400，返回 `message: "参数错误: period 仅支持 day/last7d/last30d"` 与 `allowed`；
  - `period=day` 且 `filters={}` → HTTP 200，返回分布数据；
  - `filters="not-an-object"` → HTTP 400，返回 `message: "参数错误: filters 必须为对象(JSON字典)"`。
- 目的：减少未定义变量与类型不匹配问题，提升接口健壮性与可诊断性。
---
诊断修复记录（2025-11-08 21:05）

问题描述
- Vue 控制台出现多次 `Invalid prop: type check failed for prop "trend"`，期望 `Number`，实际为 `String`（如 "11.1"）。
- 前端与后端端口配置存在硬编码，后端提示显示 `5173` 与实际前端 `3000` 不一致；怀疑旧版本代理或端口残留导致 `AxiosError`。

修复方案
- Dashboard.vue：`calculateTrend` 返回数字类型（`parseFloat(...toFixed(1))`），并增加函数级中文注释。
- Vite 配置：`vite.config.ts/js` 读取 `.env` 的 `VITE_PORT` 与 `VITE_API_TARGET`；新增 `frontend/.env.example` 与 `frontend/.env.development`。
- 后端：`api_server.py` 根路径 `preview` 与启动提示读取 `FRONTEND_URL` 或 `VITE_PORT`，API 端口读取 `API_PORT/PORT`，消除硬编码 `5173`。
- 错误日志：`stores/data.js` 在 KPI/Chart 请求失败时输出 `status`、`response` 与 `payload`。

验证与结果
- `curl` 调用 `/api/week-comparison` 成功返回数据；KPI 与图表加载成功。
- 控制台已不再出现 `trend` 类型告警；端口提示与代理配置一致。

待关注
- 若端口或代理目标调整，请同步 `.env` 并重启服务以生效。

---
诊断修复记录（2025-11-08 21:30）

问题描述
- 前端控制台报错：`ReferenceError: payload is not defined`（发生于 `Dashboard.vue` 触发 `fetchKpiData` 时）。
- 多个接口报 `AxiosError` 且状态 500（`/api/filter-options`、`/api/kpi-windows`、`/api/week-comparison`）。

根因分析
- `frontend/src/stores/data.js` 中 `payload` 变量在 `try` 内声明，`catch` 中访问不到导致 `ReferenceError`，同时无法打印请求载荷。
- 后端 Flask 服务未运行导致前端代理到 `localhost:5001` 失败，返回 500。

修复方案
- 提升 `payload` 变量至函数级作用域，保证 `catch` 可访问并打印请求载荷；保留更详细的 Axios 错误日志输出（状态码、响应体、载荷）。
- 启动后端服务：`python3 backend/api_server.py`；端口读取环境变量 `API_PORT`/`PORT`（默认 5001）。

验证与结果
- `GET /api/filter-options` 返回可用筛选选项 JSON。
- `POST /api/kpi-windows` 返回三口径数据，含 `day/last7d/last30d`。
- 前端控制台不再出现 `payload 未定义`；接口 200 正常返回。

建议
- 本地开发确保前后端均已启动：前端 `npm run dev`（端口 `VITE_PORT`），后端 `python backend/api_server.py`（端口 `API_PORT`/`PORT`）。
- 修改 `.env.development` 后重启服务以生效；必要时在 `frontend/src/stores/data.js` 观察错误日志是否包含 `status`、`response` 与 `payload`。

---
变更记录（2025-11-09 关键词：单位与布局）

问题/目标
- 视觉一致性：保费相关指标希望统一以“万元整数”显示，减少单位切换的认知负担。
- 可读性：动态标签的“箭头 + 变化值 + 变化率”信息需要更清晰的对齐和分栏展示。

实现内容
- 周对比趋势图（`ChartView.vue`）：
  - 当 `currentMetric === 'premium'` 时，`formatNumber` 以“万元整数”显示（含轴与 tooltip）。
  - Tooltip 行布局从 5 列升级为 6 列：色点 / 日期 / 当期值 / 箭头（独立列） / 变化值 / 变化幅度；增大列间距与行距。
- KPI 卡片（`KpiCard.vue` + `Dashboard.vue`）：
  - 新增 `valueType: 'wanInt'`，以“万元整数”显示保费、佣金与目标差距；单量仍为 `number`。

验证与结果
- 预览地址 `http://localhost:3001/` 加载正常；保费/佣金/目标差距统一以“万元整数”显示；周对比 tooltip 箭头独立列对齐清晰。

建议
- 后续如需切换单位（万元/千元/元），可在 `useAppStore` 增加单位偏好并在 `ChartView.vue`/`KpiCard.vue` 分支格式化。

---
新增问题项 — 2025-11-09

1) 年度保费计划维度与匹配策略
- 背景：年度保费计划需与实际业绩做对比，目前存在计划维度不一致（总部/机构/团队/业务员）导致匹配困难。
- 风险：维度不一致会造成计划对比口径不统一，影响 KPI 解读。
- 建议：
  - 计划表维度统一为“三级机构/团队/业务员”三层，至少保证能降维至“团队/业务员”。
  - 后端对接时，提供维度字典与降维规则（优先按业务员，其次团队，最后机构）。
  - 若某维度缺失，返回 `ambiguity: true` 与 `missing_dimension` 详情，前端展示告警。

2) “是否异地车”取值范围与映射
- 背景：源数据存在“是/否/空/其他”混用，影响聚合与占比类 KPI。
- 建议：
  - 规范为布尔或枚举 {是, 否}；空值统一映射为“未知”。
  - 前端显示为三态（是/否/未知），后端统计时“未知”不纳入分母。

3) 商险集合配置与渠道归属
- 背景：商业险口径涉及不同子险种组合，渠道（电销/个代/其它）认定规则不同。
- 建议：
  - 在后端维护商险集合配置（JSON/表），并返回 `mandatory/commercial` 的明细与归属渠道标记。
  - 前端按约定只显示聚合结果，避免在 UI 侧解读子险种口径。

4) 业务员筛选与保单号映射冲突
- 背景：保单号唯一，但历史数据可能存在保单与业务员/团队映射不一致的情况。
- 风险：筛选“业务员”时，若某保单映射到不同业务员，会导致统计口径不一致。
- 建议：
  - 以“保单号唯一”作为底层关联，但前端默认以“业务员”作为筛选入口。
  - 出现冲突时后端返回 `conflicts` 明细，前端弹出告警提示并在汇总中剔除冲突样本（可配置）。

5) 新增占比类 KPI 口径的歧义
- 背景：`电销保费占比`、`新能源件数占比`、`过户车件数占比` 等新口径需明确分子/分母规则。
- 建议：
  - 分母统一为当前数据范围内的总保费/总件数（按指标而定），分子按规则集合筛选（渠道=电销、车辆类型=新能源/过户）。
  - 分母为 0 返回 0.0；比例裁剪至 [0,1]，并在文档中标注异常值策略。

跟踪与验收
- 后端：在 `get_kpi_windows` 与 `get_week_comparison` 返回中贯彻一致的 `filters` 与 `metric` 载荷处理；对冲突与缺失维度返回结构化标记。
- 前端：`Dashboard.vue` 置顶工具栏以“业务员”为主筛选，KPI 与图表统一消费全局 `currentMetric`；`ChartView.vue` 不再暴露局部指标切换。
## 回归与值域登记（2025-11-09）
- `是否续保` 值域确认：应包含“新保/续保”，若出现“是/否”等异值需在数据清洗层统一映射到“新保/续保”。
- `险别组合` 类型确认：应包含“单交”类型；如数据中缺失需通过规则（仅交强险、不含商险）回推并在数据处理层生成一致的类型值。
- 监控占比双口径检查：所有指标（商险/新能源/过户车/融合销售/异地车/单交/新保）必须同时返回 `count` 与 `premium`；分母为 0 时占比为 0。
- 验收要点：切换口径应触发占比变化且公式一致；API 契约 `/api/kpi-windows.ratios.*` 字段完整。
### 值域与验收（2025-11-09 晚）
- `是否续保` 值域为：`新保/转保/续保`。新保占比使用 `新保` 作为识别值；如出现其他值（异常值域）需在清洗层映射并记录。
- 单交识别：仅以“险别组合=单交”为准，不再设“仅交强不含商险”的回退规则。
- 默认口径与视觉：监控指标默认展示 `premium`，切换到 `count` 无需确认但需有明显视觉反馈；筛选类统一视觉（字体大小、颜色与状态）。
- 验收要点：API 返回双口径字段完整；切换后视觉状态正确；筛选类控件风格一致，无漂移。

## 已实施更新 — 2025-11-09（双口径补齐与标签统一）

- 标签与术语：将全局指标切换按钮的“客户数”更名为“件数”，统一与筛选控件的视觉状态（默认/悬停/选中）。
- 后端返回：`get_kpi_windows` 为 `new_energy/transfer/mandatory/commercial` 提供 `premium/count` 双版本；新增 `ratios.single_mandatory` 与 `ratios.new_policy`（均支持双口径）。
- 前端卡片：Dashboard 替换“交强占比”为“单交占比”，新增“新保占比”；数据源为 `kpiData.ratios.single_mandatory/new_policy`。
- 端口占用：后端 `5001` 已有进程，复用现有服务进行联调；前端预览使用 `http://localhost:3010/` 正常验证。
- 回归观察：切换“保费/件数”占比值联动刷新；分母为 0 显示 `0.0%`；视觉高亮状态正确。

## 新增问题项 — 2025-11-09（清亏业务占比）

- 值域一致性：
  - `车险新业务分类` 可能存在同义/大小写/空白差异（如“清亏业务/清亏/亏损”），需在清洗层统一映射为标准值 `清亏业务`。
  - 空值处理：空或未知分类不纳入分子；分母仍按当前口径（保费/件数）统计。

- 负值与分母规则：
  - 保费口径是否包含批改负值：当前按“签单/批改保费”取净额，参与分母；如需剔除将新增 `premium_net_only` 配置并记录契约变更。
  - 件数口径分母为总件数（按当前数据范围与筛选后集合）。

- 前端显示与联动：
  - 显示为 `XX.X%`，随全局 `currentMetric`（保费/件数）切换联动刷新；分母为 0 显示 `0.0%`。
  - 迷你折线显示三窗口（Day/7D/30D），与其他占比卡一致。

- 回归用例（登记）：
  - 切换 `currentMetric` 至 `premium/count`，清亏占比随口径变化；分母为 0 返回 0.0。
  - 抽样 `车险新业务分类=清亏业务` 的样本核对分子集合；异常值（空/同义词）映射后结果一致。

> 跟进：如发现“清亏业务”分类存在多语义或历史命名，需在 `backend/data_processor.py` 的掩码函数中维护映射表，并在文档（README/PRD-best/CLAUDE）同步契约说明。
### 布局与标题规范（已修复）— Dashboard 三分区与中文标题

- 问题：用户反馈“核心KPI是三个，你实现的不一致，既然分了区，就要有标题”。
- 原因：模板中核心区混入“目标差距”，且缺少分区中文标题，造成信息架构不清。
- 修复：
  - 将模板拆分为三分区“核心KPI/监控占比/计划达成”，每区新增中文标题。
  - 核心KPI区仅保留三张卡：签单保费/签单单量/签单佣金。

## 诊断修复记录 — 2025-11-09（日期筛选与去重向量化）

- 修复范围：统一 `backend/data_processor.py` 中所有“按天”筛选与星期索引的实现。
  - 日期筛选：将 `df['投保确认时间'].dt.date == anchor.date()`、区间比较等写法统一替换为 `df['投保确认时间'].dt.normalize() == anchor.normalize()` 与基于 `.dt.normalize()` 的区间掩码（避免 `date/NaT/时区` 混合类型）。
  - 星期索引：`get_week_trend`/`get_week_comparison` 中的 `date_obj.weekday()` 与 `apply(lambda ...)` 统一替换为向量化 `df['投保确认时间'].dt.dayofweek` 与基于起始日的差值计算，保持“周一=0”的语义不变。
- 去重修复：将 `get_policy_mapping` 的 `drop_duplicates(subset=['保单号'], keep='first')` 与 `merge_with_existing` 的 `drop_duplicates(subset=['保单号','投保确认时间'], keep='last')` 改为使用 `duplicated(keep='first'/'last')` 生成布尔掩码后反选，避免在混合类型列下 `drop_duplicates` 偶发的类型报错。
- 背景原因：
  - `.dt.date` 产生 Python `date` 对象，易与 `NaT`/时区值混合导致比较不稳定；标量 `weekday()` 也不利于批量分组与窗口计算。
  - `drop_duplicates` 在某些版本下对混合类型列（文本/日期）会触发类型检查路径，导致异常；改为 `duplicated` 掩码更稳健且语义可控。
- 兼容性与口径：
  - 星期索引仍采用 `dayofweek`（周一=0）；周窗口（D/D-7/D-14）计算逻辑与视觉展示不变。
  - 保单号与投保确认时间的去重口径保持与原实现一致（映射保单保留首条；历史合并保留最新一条）。
- 验证：
  - 构造包含 `NaT`/不同时区的样本，日期筛选与周索引正常；重复样本按预期保留/剔除；周对比与 KPI 接口返回结构与值域一致。
- 回归计划：
  - 对 `D/D-7/D-14` 的索引与 tooltip 展示进行抽样验证；记录异常样本至本表并跟进处理。
  - 计划达成区默认显示“目标差距”，当 `plan_exists=true` 时追加“保费达成率/保费缺口”。
- 验收：
  - 页面出现三处中文分区标题；核心区仅三卡；切换“保费/件数”与时间窗口时监控占比卡联动刷新；计划命中时显示达成率/缺口。
### 问题：字段说明文档体积过大导致渲染卡顿（2025-11-09）

- 现象：`车险清单_2025年10-11月_合并-字段说明.md` 中“厂牌车型名称”字段列出 6495 条精友车型取值，页面滚动与渲染性能明显下降。
- 根因：在主说明文档内直接展开大型枚举明细，不利于阅读与维护。
- 处理：使用 HTML 注释隐藏该明细段落；保留字段统计与描述，完整明细移至归档/脚本生成。
- 结果：文档可读性与性能改善。
## 2025-11-09 Bug 修复记录：业务员“乔军”筛选无数据

- 问题现象：在全局筛选面板选择业务员（如“乔军”）后，图表与KPI数据为空或无变化。
- 根因分析：
  - 前端 GlobalFilterPanel 的业务员选项来源于 `policy-mapping` 的 `staff_to_info`，键为“中文姓名”；
  - 后端数据列 `业务员` 存储的是“工号+姓名”（如 `200046585刘洋新`）；
  - 原后端 `_apply_filters` 对“业务员”使用等值过滤，传入中文姓名时与数据列不相等，导致无匹配返回。
- 解决方案：
  - 后端 `data_processor._apply_filters` 增强“业务员”过滤逻辑，兼容两种格式：
    1) 若传入为“工号+姓名”，按等值过滤；
    2) 若传入为“中文姓名”，先通过映射反查对应 `staff_key` 集合（工号+姓名）；若无映射命中，回退为对数据列提取中文姓名后匹配。
- 代码位置：`backend/data_processor.py` 中 `_apply_filters` 函数。
- 验证方式：
  - 新增测试 `backend/test_staff_filter.py`，从 `policy-mapping` 自动选取一个姓名，调用 `get_kpi_windows(filters={'业务员': name})` 验证返回有效数据。
  - 运行结果：姓名筛选返回当日、近7天、近30天保费均为有效数值。
- 影响范围：
  - 全局业务员筛选（GlobalFilterPanel）；
  - 单独筛选面板（FilterPanel）保持原有“工号+姓名”选项不受影响。