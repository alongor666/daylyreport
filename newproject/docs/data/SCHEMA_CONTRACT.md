# 数据结构契约

## 任务交代
本文件用于指导后续的智能助手或工程同学构建每日车险签单数据的入湖、校验与派生逻辑。阅读者需要基于本文的要求，实现数据摄取脚本、表结构、字段校验、映射冲突检测以及派生指标生成，确保后续的后端接口和前端分析都能在统一口径下运行。

## 数据源与批次
- 每日输入：单个或多个电子表格清单（支持 xls、xlsx、csv），字段总数 76，记录量约 5.5 万行。
- 必须记录批次日期、文件名、行数、校验通过与否，并将结果写入 `data/logs/`。
- 任何字段不满足契约需立即失败并输出错误说明。

## 基础字段规范（节选）
| 字段名 | 数据类型 | 是否允许为空 | 特殊说明 |
|--------|----------|--------------|----------|
| 刷新时间 | 日期时间 | 否 | 允许“年-月-日”或“年-月-日 时:分:秒”，导入时统一成 UTC+8 日期时间。 |
| 投保确认时间 | 日期时间 | 否 | 所有时间筛选与周对比的锚定字段。 |
| 保险起期 | 日期时间 | 否 | 仅用于背景信息，但仍需校验合法日期。 |
| 保单号 | 字符串 | 否 | 主键；允许数字或字符串混排，导入后统一转为字符串。 |
| 业务员 | 字符串 | 否 | 可能包含“工号+姓名”，需额外解析中文姓名。 |
| 三级机构 | 字符串 | 否 | 允许取值：乐山、天府、宜宾、德阳、新都、武侯、泸州、自贡、资阳、达州、青羊、高新。 |
| 团队简称 | 字符串 | 是 | 允许缺失或 `'null'` 字符串，入湖时需转为空。 |
| 客户类别3 | 字符串 | 否 | 取值需与《原始数据字段说明》一致，如“非营业个人客车”“摩托车”等。 |
| 终端来源 | 字符串 | 否 | 取值若为 `0110融合销售` 则判定为电销。 |
| 是否新能源 | 字符串 | 否 | 仅允许“是”“否”。 |
| 是否过户车 | 字符串 | 否 | 仅允许“是”“否”。 |
| 是否异地车 | 字符串 | 否 | 仅允许“是”“否”。 |
| 是否续保 | 字符串 | 否 | 仅允许“新保”“续保”“转保”。 |
| 险种名称 | 字符串 | 否 | 仅允许 0301、0312、0313、0317 所属的中文全称。 |
| 签单/批改保费 | 数值 | 否 | 以元为单位，可为负值；导入后统一为浮点。 |
| 签单数量 | 数值 | 否 | 非负整数。 |
| 手续费含税 | 数值 | 否 | 以元为单位，可为负值。 |

其余字段按原清单保持“同名直传”；完整字段列表请在实现时从数据源自动解析并生成对照表。

## 派生字段
| 字段名 | 计算方式 | 备注 |
|--------|----------|------|
| 当日/近七日/近三十日保费 | 按时间窗口聚合 `签单/批改保费` | 输出单位：万元整数，四舍五入。 |
| 当日/近七日/近三十日件数 | 聚合 `签单数量` | 以件为单位，千分位展示。 |
| 当日/近七日/近三十日手续费 | 聚合 `手续费含税` | 以万元整数输出。 |
| 当日目标缺口 | `当日保费 - 日目标` | 日目标默认为 200000 元，可通过配置覆盖。 |
| 电销标记 | `终端来源 == 0110融合销售` | 以布尔或 0/1 存储。 |
| 商业险标记 | `险种名称` 属于商险集合 | 集合默认含 0312、0313、0317，可配置。 |
| 新能源标记 | `是否新能源 == 是` | —— |
| 过户车标记 | `是否过户车 == 是` | —— |
| 异地车标记 | `是否异地车 == 是` | —— |
| 各类占比 | 以上标记对应的占比，范围 0~1 | 不在前端重新计算。 |

## 映射文件契约
- 文件位置：`data/mappings/staff_mapping.sample.json`（真实运行时需提供正式版本）。
- 键：工号与姓名拼接，例如 `200049147向轩颉`。
- 值包含：`三级机构`（必填）、`四级机构`（可选）、`团队简称`（可选）、`status`（在岗/离岗）。
- 导入时需：
  1. 解析键中的中文姓名作为唯一键。
  2. 若同名不同机构，记录冲突并计数 `mismatch_count`。
  3. 构建 `policy_to_staff`（保单号→姓名）与 `staff_to_info` 映射。

## 校验规则
1. **日期范围**：刷新时间与投保确认时间必须在当批次日期前后 30 天内，否则视为脏数据。
2. **枚举校验**：所有枚举型字段按上文取值集合检查，不在集合内直接报错。
3. **数值校验**：金额字段允许负值但不允许空；如果无法解析为数字则报错。
4. **唯一性**：同一保单号+投保确认时间只能保留最新记录，按输入顺序覆盖。
5. **映射完整性**：若保单号对应业务员在映射中缺失，需在验证信息中列出，方便前端提示。

## 输出表设计（建议）
- `raw_records`：按批次存储的明细数据，包含所有基础字段与派生 flag。
- `daily_aggregate`：以日期、机构、团队、业务员等维度聚合的指标表。
- `policy_staff_map`：保单号→业务员→机构/团队映射表。

## AI 实施须知
在实现数据摄取或后续接口、前端时，务必先读取本契约，确保：
1. 不自行新增字段或口径。
2. 派生指标与占比只在后端计算。
3. 任何违反契约的数据必须被拒绝或标记，并在日志与验证信息中体现。
